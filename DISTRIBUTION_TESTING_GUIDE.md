# 分销系统测试指南

## 📋 测试前准备

### 1. 确保数据库已同步
```bash
npx prisma db push
```

### 2. 启动开发服务器
```bash
npm run dev
```

### 3. 准备测试账号
- **管理员账号**：用于审核分销商和查看后台数据
- **普通用户账号 A**：用于申请成为分销商
- **普通用户账号 B**：用于测试通过分销链接购买

---

## 🧪 完整测试流程

### 阶段 1：分销商申请（用户 A）

#### 1.1 访问分销页面
```
URL: http://localhost:3000/distribution
```

#### 1.2 填写申请表单
- **姓名**：张三
- **手机**：13800138000
- **邮箱**：zhangsan@example.com
- **推广计划**：
  ```
  我计划通过以下方式推广：
  1. 在我的技术博客发布课程评测
  2. 在微信朋友圈分享学习心得
  3. 在技术社区推荐优质课程
  预计每月能带来 10-20 个新用户
  ```

#### 1.3 提交申请
- 点击"提交申请"按钮
- 应该看到成功提示
- **状态**应显示为"待审核"

**预期结果：**
```
✅ 申请提交成功
📋 状态：待审核（pending）
⏳ 等待管理员审核
```

---

### 阶段 2：管理员审核

#### 2.1 登录管理员账号
```
URL: http://localhost:3000/auth/signin
```

#### 2.2 进入分销管理后台
```
路径：后台首页 → 点击"💰 分销管理"卡片
URL: http://localhost:3000/backendmanager/distribution
```

#### 2.3 查看申请列表
应该看到：
```
┌─────────────────────────────────────────────┐
│ 📊 统计面板                                  │
│ • 总分销商数: 1                              │
│ • 待审核: 1                                  │
│ • 活跃分销商: 0                              │
│ • 总佣金支出: ¥0.00                          │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│ 分销商列表                                   │
│ 姓名: 张三                                   │
│ 联系方式: 13800138000 / zhangsan@...        │
│ 状态: 🟡 待审核                              │
│ 申请时间: 2025-XX-XX                         │
│ [批准] [拒绝]                                │
└─────────────────────────────────────────────┘
```

#### 2.4 批准申请
1. 点击"批准"按钮
2. 弹出对话框，输入佣金比例：`0.15`（15%）
3. 点击"确认批准"

**预期结果：**
```
✅ 审核成功
📝 生成唯一分销码（如：A1B2C3D4）
💰 佣金比例：15%
🟢 状态变为：已激活
```

---

### 阶段 3：分销商使用（用户 A）

#### 3.1 重新访问分销页面
```
URL: http://localhost:3000/distribution
```

应该看到完整的分销商控制面板：

```
┌─────────────────────────────────────────────┐
│ 🎉 您的分销账号                              │
│ 分销码: A1B2C3D4                             │
│ 状态: ✅ 已激活                              │
│ 佣金比例: 15%                                │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│ 📊 数据统计                                  │
│ • 总收益: ¥0.00                              │
│ • 可提现: ¥0.00                              │
│ • 总点击: 0                                  │
│ • 总订单: 0                                  │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│ 🔗 推广链接                                  │
│ 产品列表:                                    │
│ [选择课程] → [生成链接]                      │
└─────────────────────────────────────────────┘
```

#### 3.2 生成分销链接
1. 在"产品列表"下拉框中选择一个课程（如"Python 入门课程"）
2. 点击"生成链接"
3. 复制生成的链接，格式应为：
   ```
   http://localhost:3000/products/xxx?ref=A1B2C3D4
   ```

#### 3.3 分享链接
- 复制链接
- 在新的隐私/无痕浏览器窗口打开（模拟新用户）

**预期结果：**
```
✅ 分销链接生成成功
🔗 链接包含分销码参数 ?ref=A1B2C3D4
📝 点击后会记录追踪数据
```

---

### 阶段 4：通过分销链接购买（用户 B）

#### 4.1 打开分销链接
```
在新的隐私窗口打开：
http://localhost:3000/products/xxx?ref=A1B2C3D4
```

#### 4.2 检查追踪
打开浏览器开发者工具（F12）→ Application → Cookies
应该看到：
```
Cookie名: dist_code
Cookie值: A1B2C3D4
过期时间: 7天后
```

#### 4.3 完成购买流程
1. 点击"立即购买"
2. 如果未登录，先登录/注册（用户 B 账号）
3. 创建订单
4. 进入支付页面
5. 选择支付方式（测试环境可以模拟支付）
6. 完成支付

**注意**：当前分销系统的佣金计算需要在支付回调中实现（参考 `DISTRIBUTION_SYSTEM_README.md`）

---

### 阶段 5：查看佣金和统计

#### 5.1 分销商查看收益（用户 A）
访问 `http://localhost:3000/distribution`

应该看到：
```
┌─────────────────────────────────────────────┐
│ 📊 数据统计                                  │
│ • 总收益: ¥XX.XX                             │
│ • 可提现: ¥XX.XX                             │
│ • 总点击: 1                                  │
│ • 总订单: 1                                  │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│ 📦 最近订单                                  │
│ • 订单号: ORD-XXXXXX                         │
│ • 金额: ¥99.00                               │
│ • 佣金: ¥14.85 (15%)                         │
│ • 时间: 刚刚                                 │
└─────────────────────────────────────────────┘
```

#### 5.2 管理员查看统计
访问 `http://localhost:3000/backendmanager/distribution`

应该看到更新的统计数据：
```
┌─────────────────────────────────────────────┐
│ 📊 统计面板                                  │
│ • 总分销商数: 1                              │
│ • 待审核: 0                                  │
│ • 活跃分销商: 1                              │
│ • 总佣金支出: ¥14.85                         │
└─────────────────────────────────────────────┘
```

---

### 阶段 6：提现申请（用户 A）

#### 6.1 发起提现
在分销页面：
1. 输入提现金额（如：10.00）
2. 输入支付宝账号：zhangsan@example.com
3. 输入真实姓名：张三
4. 点击"申请提现"

**预期行为：**
```
✅ 提现申请提交成功
💰 提现金额: ¥10.00
💳 手续费: ¥0.20 (2%)
📥 实际到账: ¥9.80
📋 状态: 待处理
```

#### 6.2 查看提现记录
在分销页面应该看到提现历史：
```
┌─────────────────────────────────────────────┐
│ 💰 提现记录                                  │
│ • 金额: ¥10.00                               │
│ • 手续费: ¥0.20                              │
│ • 实际: ¥9.80                                │
│ • 状态: 🟡 待处理                            │
│ • 时间: 刚刚                                 │
└─────────────────────────────────────────────┘
```

---

## 🔍 测试检查点

### ✅ 功能检查清单

- [ ] **申请流程**
  - [ ] 表单验证正常（必填项、格式校验）
  - [ ] 申请提交成功
  - [ ] 状态显示为"待审核"
  - [ ] 不能重复申请

- [ ] **管理员审核**
  - [ ] 能看到待审核申请
  - [ ] 批准功能正常，生成分销码
  - [ ] 拒绝功能正常，可填写原因
  - [ ] 统计数据实时更新

- [ ] **分销链接**
  - [ ] 链接生成正确，包含 ref 参数
  - [ ] Cookie 正确设置（7天有效期）
  - [ ] 点击追踪正常记录

- [ ] **订单关联**
  - [ ] 通过分销链接购买的订单正确关联分销商
  - [ ] 佣金计算正确（订单金额 × 佣金比例）
  - [ ] 统计数据正确更新

- [ ] **提现功能**
  - [ ] 最小提现金额校验（10元）
  - [ ] 余额不足提示
  - [ ] 手续费计算正确（2%）
  - [ ] 提现后余额扣减正确

---

## 🐛 常见问题排查

### 问题 1：看不到"分销管理"入口
**原因**：用户没有 DISTRIBUTION 权限
**解决**：
1. 检查用户角色是否为 ADMIN
2. 或者在后台权限管理给用户添加 DISTRIBUTION 权限

### 问题 2：分销链接无效
**检查**：
1. 浏览器 Cookie 是否被禁用
2. 分销码是否正确（8位大写字母+数字）
3. 查看 `/api/distribution/track` API 是否有错误

### 问题 3：佣金未计算
**原因**：当前版本的佣金计算需要在支付回调中实现
**临时解决**：手动在数据库创建 DistributionOrder 记录
**长期方案**：参考 `DISTRIBUTION_SYSTEM_README.md` 集成支付回调

### 问题 4：统计数据不准确
**检查**：
1. 确认订单的 `distributorId` 字段是否正确设置
2. 检查 `DistributionOrder` 表是否有对应记录
3. 查看 `/api/distribution/stats` API 返回数据

---

## 📊 数据库检查

### 查看分销商数据
```sql
-- 查看所有分销商
SELECT * FROM "Distributor";

-- 查看分销订单
SELECT * FROM "DistributionOrder";

-- 查看点击追踪
SELECT * FROM "DistributionClick";

-- 查看提现记录
SELECT * FROM "CommissionWithdrawal";
```

### 模拟数据（可选）
如果需要快速测试，可以直接在数据库创建测试数据：

```sql
-- 创建测试分销商
INSERT INTO "Distributor" (id, "userId", code, "commissionRate", status)
VALUES ('test-dist-id', 'user-id', 'TESTCODE', 0.15, 'active');

-- 创建测试分销订单
INSERT INTO "DistributionOrder" (
  id, "orderId", "distributorId", "orderAmount", commission, status
) VALUES (
  'test-order-id',
  'order-id',
  'test-dist-id',
  99.00,
  14.85,
  'pending'
);
```

---

## 🎯 API 测试（可选）

### 使用 curl 测试 API

```bash
# 1. 申请成为分销商
curl -X POST http://localhost:3000/api/distribution/apply \
  -H "Content-Type: application/json" \
  -d '{
    "contactName": "测试用户",
    "contactPhone": "13800138000",
    "contactEmail": "test@example.com",
    "promotionPlan": "测试推广计划"
  }'

# 2. 获取分销商信息
curl http://localhost:3000/api/distribution/info

# 3. 获取统计数据
curl http://localhost:3000/api/distribution/stats?type=overview

# 4. 追踪点击
curl -X POST http://localhost:3000/api/distribution/track \
  -H "Content-Type: application/json" \
  -d '{"code": "A1B2C3D4", "productId": "product-id"}'

# 5. 申请提现
curl -X POST http://localhost:3000/api/distribution/withdrawals \
  -H "Content-Type: application/json" \
  -d '{
    "amount": 10,
    "accountType": "alipay",
    "accountNumber": "test@example.com",
    "accountName": "测试用户"
  }'
```

---

## 📝 测试报告模板

完成测试后，可以使用以下模板记录结果：

```
# 分销系统测试报告

测试时间: 2025-XX-XX
测试人员: XXX

## 测试环境
- Node.js: vXX.X.X
- Next.js: v16.0.3
- 数据库: PostgreSQL

## 测试结果

### ✅ 通过的功能
- [ ] 分销商申请
- [ ] 管理员审核
- [ ] 分销链接生成
- [ ] 订单追踪
- [ ] 佣金计算
- [ ] 提现申请

### ❌ 发现的问题
1. 问题描述...
2. 复现步骤...
3. 预期结果 vs 实际结果...

### 💡 改进建议
1. ...
2. ...

## 性能测试
- 分销商列表加载时间: XX ms
- API 响应时间: XX ms
```

---

## 🚀 下一步

测试完成后，您可能需要：

1. **集成支付回调**：在订单支付成功后自动计算佣金
   - 参考 `DISTRIBUTION_SYSTEM_README.md`
   - 修改 `/api/payment/callback/route.ts`

2. **添加管理员提现审核**：
   - 后台查看提现申请
   - 批准/拒绝提现
   - 标记已打款

3. **完善统计报表**：
   - 月度/年度收益图表
   - 转化率分析
   - 导出数据功能

4. **优化用户体验**：
   - 添加分销商等级制度
   - 推广素材下载
   - 实时通知功能

---

## 📚 相关文档

- **分销系统完整文档**: `DISTRIBUTION_SYSTEM_README.md`
- **API 文档**: 见 `DISTRIBUTION_SYSTEM_README.md` 中的 API 章节
- **数据库模型**: `prisma/schema.prisma`

---

**祝测试顺利！** 🎉

如有问题，请查看控制台日志或数据库数据进行排查。
