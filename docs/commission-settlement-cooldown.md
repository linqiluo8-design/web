# ä½£é‡‘ç»“ç®—å†·é™æœŸæœºåˆ¶

## ğŸ“‹ é—®é¢˜èƒŒæ™¯

### åŸæœ‰çš„å®‰å…¨æ¼æ´

åœ¨ä¹‹å‰çš„åˆ†é”€ç³»ç»Ÿä¸­å­˜åœ¨ä¸€ä¸ªä¸¥é‡çš„å®‰å…¨æ¼æ´ï¼š

1. ç”¨æˆ·é€šè¿‡åˆ†é”€é“¾æ¥è´­ä¹°å•†å“ â†’ è®¢å•æ”¯ä»˜æˆåŠŸ
2. æ”¯ä»˜å›è°ƒ**ç«‹å³**å°†ä½£é‡‘ç»“ç®—ä¸º `settled` çŠ¶æ€ï¼Œå¹¶åŠ å…¥åˆ†é”€å•†çš„ `availableBalance`ï¼ˆå¯æç°ä½™é¢ï¼‰
3. åˆ†é”€å•†å¯ä»¥**é©¬ä¸Šæç°**
4. âš ï¸ **å¦‚æœç”¨æˆ·ç”³è¯·é€€æ¬¾ï¼Œåˆ†é”€å•†å·²ç»æç°æˆåŠŸï¼Œå¹³å°ä¼šæ‰¿å—æŸå¤±**

### é£é™©åœºæ™¯

- æ¶æ„åˆ†é”€å•†ä¸ä¹°å®¶å‹¾ç»“ï¼šä¹°å®¶è´­ä¹° â†’ åˆ†é”€å•†ç«‹å³æç° â†’ ä¹°å®¶é€€æ¬¾
- æ­£å¸¸ä¹°å®¶çš„ä¸ƒå¤©æ— ç†ç”±é€€è´§ï¼šåˆ†é”€å•†å·²æç°ï¼Œé€€æ¬¾æ—¶æ— æ³•è¿½å›ä½£é‡‘
- è™šå‡äº¤æ˜“ï¼šåˆ·å•åç«‹å³æç°ï¼Œè®¢å•è¢«å‘ç°åå–æ¶ˆ

## âœ… è§£å†³æ–¹æ¡ˆï¼šå»¶è¿Ÿç»“ç®—æœºåˆ¶

### æ ¸å¿ƒè®¾è®¡

```
è®¢å•æ”¯ä»˜æˆåŠŸ
    â†“
ä½£é‡‘çŠ¶æ€ï¼špending â†’ confirmedï¼ˆå·²ç¡®è®¤ï¼‰
ä½£é‡‘æš‚å­˜ï¼špendingCommissionï¼ˆå¾…ç»“ç®—ä½£é‡‘ï¼‰â³
    â†“
ç­‰å¾…ç»“ç®—å†·é™æœŸï¼ˆé»˜è®¤ 15 å¤©ï¼‰
    â†“
æ— é€€æ¬¾ â†’ è‡ªåŠ¨ç»“ç®— âœ…
ä½£é‡‘çŠ¶æ€ï¼šconfirmed â†’ settled
ä½£é‡‘è½¬å…¥ï¼šavailableBalanceï¼ˆå¯æç°ä½™é¢ï¼‰
    â†“
åˆ†é”€å•†å¯ä»¥æç°

ã€å†·é™æœŸå†…é€€æ¬¾ã€‘
    â†“
ä½£é‡‘çŠ¶æ€ï¼šconfirmed â†’ cancelled âŒ
ä» pendingCommission ä¸­æ‰£é™¤
```

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. ç³»ç»Ÿé…ç½®

**æ–°å¢é…ç½®é¡¹**ï¼š`commission_settlement_cooldown_days`

- é»˜è®¤å€¼ï¼š15 å¤©
- è¯´æ˜ï¼šè®¢å•æ”¯ä»˜åéœ€ç­‰å¾…æ­¤æœŸé™æ‰èƒ½ç»“ç®—ä½£é‡‘
- é…ç½®æ–‡ä»¶ï¼š`scripts/init-withdrawal-configs.ts`

### 2. æ”¯ä»˜å›è°ƒä¿®æ”¹

**æ–‡ä»¶ä¿®æ”¹**ï¼š
- `/app/api/payment/callback/route.ts`
- `/app/api/payment/callback/wechat/route.ts`
- `/app/api/payment/callback/alipay/route.ts`
- `/app/api/payment/callback/paypal/route.ts`

**å…³é”®å˜æ›´**ï¼š

```typescript
// âŒ æ—§é€»è¾‘ï¼ˆæœ‰æ¼æ´ï¼‰
await prisma.distributionOrder.update({
  where: { id: distributionOrder.id },
  data: {
    status: "settled",  // ç«‹å³ç»“ç®—
    confirmedAt: new Date(),
    settledAt: new Date()
  }
})

await prisma.distributor.update({
  where: { id: order.distributorId },
  data: {
    totalEarnings: { increment: commissionAmount },
    availableBalance: { increment: commissionAmount }  // ç«‹å³å¯æç°
  }
})

// âœ… æ–°é€»è¾‘ï¼ˆå®‰å…¨ï¼‰
await prisma.distributionOrder.update({
  where: { id: distributionOrder.id },
  data: {
    status: "confirmed",  // ä»…ç¡®è®¤ï¼Œä¸ç»“ç®—
    confirmedAt: new Date()
    // ä¸è®¾ç½® settledAtï¼Œç­‰å¾…å†·é™æœŸ
  }
})

await prisma.distributor.update({
  where: { id: order.distributorId },
  data: {
    totalEarnings: { increment: commissionAmount },
    pendingCommission: { increment: commissionAmount }  // è¿›å…¥å¾…ç»“ç®—
  }
})
```

### 3. è‡ªåŠ¨ç»“ç®—å®šæ—¶ä»»åŠ¡

**æ¥å£**ï¼š`GET /api/cron/settle-commissions`

**åŠŸèƒ½**ï¼š
- æŸ¥æ‰¾æ‰€æœ‰çŠ¶æ€ä¸º `confirmed` ä¸”ç¡®è®¤æ—¶é—´è¶…è¿‡å†·é™æœŸçš„åˆ†é”€è®¢å•
- å°†ä½£é‡‘ä» `pendingCommission` è½¬ç§»åˆ° `availableBalance`
- æ›´æ–°åˆ†é”€è®¢å•çŠ¶æ€ä¸º `settled`

**è°ƒç”¨æ–¹å¼**ï¼š
```bash
# æ‰‹åŠ¨è§¦å‘
curl https://your-domain.com/api/cron/settle-commissions

# æˆ–é…ç½® cron jobï¼ˆæ¨èæ¯å¤©å‡Œæ™¨æ‰§è¡Œï¼‰
0 2 * * * curl https://your-domain.com/api/cron/settle-commissions
```

**Vercel Cron Jobs é…ç½®**ï¼š
```json
{
  "crons": [{
    "path": "/api/cron/settle-commissions",
    "schedule": "0 2 * * *"
  }]
}
```

### 4. é€€æ¬¾å¤„ç†æ¥å£

**æ¥å£**ï¼š`POST /api/orders/[id]/refund`

**æƒé™**ï¼šä»…ç®¡ç†å‘˜å¯è°ƒç”¨

**åŠŸèƒ½**ï¼š
1. å°†è®¢å•çŠ¶æ€æ”¹ä¸º `refunded`
2. æ ¹æ®ä½£é‡‘çŠ¶æ€å¤„ç†ï¼š

   **æƒ…å†µ Aï¼šä½£é‡‘åœ¨å†·é™æœŸå†…ï¼ˆconfirmedï¼‰**
   ```
   - ä» pendingCommission æ‰£é™¤ä½£é‡‘ âœ…
   - åˆ†é”€è®¢å•çŠ¶æ€æ”¹ä¸º cancelled
   - æ— é£é™©ï¼Œè‡ªåŠ¨å¤„ç†
   ```

   **æƒ…å†µ Bï¼šä½£é‡‘å·²ç»“ç®—ï¼ˆsettledï¼‰ä¸”ä½™é¢å……è¶³**
   ```
   - ä» availableBalance æ‰£é™¤ä½£é‡‘ âœ…
   - åˆ†é”€è®¢å•çŠ¶æ€æ”¹ä¸º cancelled
   - è‡ªåŠ¨å¤„ç†
   ```

   **æƒ…å†µ Cï¼šä½£é‡‘å·²ç»“ç®—ä½†ä½™é¢ä¸è¶³ï¼ˆå·²æç°ï¼‰**
   ```
   - æ— æ³•æ‰£é™¤ï¼Œåˆ›å»ºé«˜ä¼˜å…ˆçº§å®‰å…¨è­¦æŠ¥ âš ï¸
   - éœ€è¦äººå·¥å¤„ç†
   - å¯èƒ½éœ€è¦å‘åˆ†é”€å•†è¿½è®¨
   ```

### 5. å‰ç«¯æç¤º

**åˆ†é”€ä¸­å¿ƒé¡µé¢**ï¼ˆ`/distribution`ï¼‰ï¼š
- æ˜¾ç¤ºå¾…ç»“ç®—ä½£é‡‘é‡‘é¢
- å½“æœ‰å¾…ç»“ç®—ä½£é‡‘æ—¶ï¼Œæ˜¾ç¤ºå†·é™æœŸè¯´æ˜æç¤ºæ¡†

```
â³ å¾…ç»“ç®—ä½£é‡‘è¯´æ˜ï¼šè®¢å•æ”¯ä»˜æˆåŠŸåï¼Œä½£é‡‘ä¼šè¿›å…¥15å¤©çš„ç»“ç®—å†·é™æœŸï¼Œ
æœŸé—´å¦‚æœè®¢å•é€€æ¬¾ï¼Œä½£é‡‘å°†è‡ªåŠ¨å–æ¶ˆã€‚è¶…è¿‡å†·é™æœŸåï¼Œä½£é‡‘ä¼šè‡ªåŠ¨è½¬å…¥å¯æç°ä½™é¢ã€‚
```

## ğŸ“Š æ•°æ®æµè½¬

### ä½£é‡‘çŠ¶æ€æµè½¬

```
pending (å¾…ç¡®è®¤)
    â†“ æ”¯ä»˜æˆåŠŸ
confirmed (å·²ç¡®è®¤ï¼Œå†·é™æœŸ)
    â†“ è¶…è¿‡å†·é™æœŸ
settled (å·²ç»“ç®—ï¼Œå¯æç°)
    â†“ æç°
    å·²æç°

ã€é€€æ¬¾åœºæ™¯ã€‘
confirmed â†’ cancelled (ä½£é‡‘å–æ¶ˆï¼Œä» pendingCommission æ‰£é™¤)
settled â†’ cancelled (ä½£é‡‘å–æ¶ˆï¼Œä» availableBalance æ‰£é™¤æˆ–åˆ›å»ºè­¦æŠ¥)
```

### åˆ†é”€å•†ä½™é¢å˜åŒ–

**æ­£å¸¸æµç¨‹**ï¼š
```
æ”¯ä»˜æˆåŠŸ:
  totalEarnings +100
  pendingCommission +100

15å¤©åè‡ªåŠ¨ç»“ç®—:
  pendingCommission -100
  availableBalance +100

æç°:
  availableBalance -100
  withdrawnAmount +100
```

**é€€æ¬¾æµç¨‹ï¼ˆå†·é™æœŸå†…ï¼‰**ï¼š
```
é€€æ¬¾:
  totalEarnings -100
  pendingCommission -100
```

**é€€æ¬¾æµç¨‹ï¼ˆå·²ç»“ç®—ï¼‰**ï¼š
```
é€€æ¬¾:
  totalEarnings -100
  availableBalance -100 (å¦‚æœä½™é¢è¶³å¤Ÿ)
  æˆ–åˆ›å»ºå®‰å…¨è­¦æŠ¥ (å¦‚æœä½™é¢ä¸è¶³)
```

## ğŸ’° èµ„é‡‘æµè½¬ä¸æç°åˆ’æ‰£é€»è¾‘

### Distributor è¡¨å­—æ®µè¯´æ˜

| å­—æ®µ | è¯´æ˜ | ä½•æ—¶å¢åŠ  | ä½•æ—¶å‡å°‘ | ç”¨é€” |
|------|------|----------|----------|------|
| `totalEarnings` | **æ€»æ”¶ç›Š**ï¼ˆç»Ÿè®¡ï¼‰ | è®¢å•æ”¯ä»˜æˆåŠŸ | è®¢å•é€€æ¬¾ | ğŸ“Š å±•ç¤ºç”¨ |
| `pendingCommission` | **å¾…ç»“ç®—ä½£é‡‘**ï¼ˆå†·é™æœŸï¼‰ | è®¢å•æ”¯ä»˜æˆåŠŸ | 15å¤©åè‡ªåŠ¨ç»“ç®— / é€€æ¬¾ | â³ å†·é™æœŸæš‚å­˜ |
| `availableBalance` | **å¯æç°ä½™é¢** | å†·é™æœŸç»“æŸè‡ªåŠ¨ç»“ç®— | **ç”¨æˆ·ç”³è¯·æç°æ—¶** | ğŸ’µ **æç°åˆ’æ‰£æ¥æº** |
| `withdrawnAmount` | **å·²æç°é‡‘é¢**ï¼ˆç»Ÿè®¡ï¼‰ | ç®¡ç†å‘˜å®Œæˆæç° | æ—  | ğŸ“Š å±•ç¤ºç”¨ |

### å®Œæ•´èµ„é‡‘æµè½¬ç¤ºä¾‹

å‡è®¾ï¼šç”¨æˆ·ä¸‹å• Â¥1000ï¼Œä½£é‡‘æ¯”ä¾‹ 10%ï¼ˆÂ¥100ï¼‰

#### é˜¶æ®µ 1ï¼šè®¢å•æ”¯ä»˜æˆåŠŸ
**è§¦å‘æ–‡ä»¶**ï¼š`app/api/payment/callback/route.ts:82-88`

```typescript
await prisma.distributor.update({
  where: { id: order.distributorId },
  data: {
    totalEarnings: { increment: 100 },      // 0 â†’ 100
    pendingCommission: { increment: 100 }   // 0 â†’ 100 â³
  }
})
```

**çŠ¶æ€å˜åŒ–**ï¼š
```
totalEarnings:      0 â†’ 100
pendingCommission:  0 â†’ 100 â³ (å†·é™æœŸï¼Œä¸å¯æç°)
availableBalance:   0 â†’ 0
withdrawnAmount:    0 â†’ 0
```

ğŸ’¡ **æ­¤æ—¶é’±è¿˜ä¸èƒ½æç°**ï¼Œåªè®°å½•åœ¨å¾…ç»“ç®—ä½£é‡‘ä¸­

---

#### é˜¶æ®µ 2ï¼š15å¤©å†·é™æœŸåè‡ªåŠ¨ç»“ç®—
**è§¦å‘æ–‡ä»¶**ï¼š`app/api/cron/settle-commissions/route.ts:85-94`

```typescript
await prisma.distributor.update({
  where: { id: distributorId },
  data: {
    pendingCommission: { decrement: 100 },  // 100 â†’ 0
    availableBalance: { increment: 100 }    // 0 â†’ 100 âœ…
  }
})
```

**çŠ¶æ€å˜åŒ–**ï¼š
```
totalEarnings:      100 (ä¸å˜)
pendingCommission:  100 â†’ 0
availableBalance:   0 â†’ 100 âœ… (å¯ä»¥æç°äº†!)
withdrawnAmount:    0 â†’ 0
```

ğŸ’¡ **ç°åœ¨é’±å¯ä»¥æç°äº†**ï¼Œå·²è½¬å…¥å¯æç°ä½™é¢

---

#### é˜¶æ®µ 3ï¼šç”¨æˆ·ç”³è¯·æç°
**è§¦å‘æ–‡ä»¶**ï¼š`app/api/distribution/withdrawals/route.ts:138-146`

```typescript
await prisma.$transaction(async (tx) => {
  // æ‰£é™¤ä½™é¢ï¼ˆç«‹å³å†»ç»“ï¼‰
  await tx.distributor.update({
    where: { id: user.distributor.id },
    data: {
      availableBalance: { decrement: 100 }  // 100 â†’ 0 â„ï¸
    }
  })

  // åˆ›å»ºæç°è®°å½•
  return tx.commissionWithdrawal.create({
    distributorId: user.distributor.id,
    amount: 100,
    fee: 2,          // 2% æ‰‹ç»­è´¹
    actualAmount: 98, // å®é™…åˆ°è´¦
    status: "pending" // å¾…å®¡æ ¸
  })
})
```

**çŠ¶æ€å˜åŒ–**ï¼š
```
totalEarnings:      100 (ä¸å˜)
pendingCommission:  0 (ä¸å˜)
availableBalance:   100 â†’ 0 â„ï¸ (ä½™é¢å†»ç»“ï¼Œé˜²æ­¢é‡å¤æç°)
withdrawnAmount:    0 (ä¸å˜)
```

ğŸ’¡ **å…³é”®**ï¼šé’±ä» `availableBalance` æ‰£é™¤ï¼Œé˜²æ­¢é‡å¤æç°

---

#### é˜¶æ®µ 4ï¼šç®¡ç†å‘˜å®Œæˆæç°
**è§¦å‘æ–‡ä»¶**ï¼š`app/api/backendmanager/distribution/withdrawals/[id]/complete/route.ts:62-79`

```typescript
await prisma.$transaction(async (tx) => {
  // æ›´æ–°åˆ†é”€å•†å·²æç°é‡‘é¢ï¼ˆç»Ÿè®¡ç”¨ï¼‰
  await tx.distributor.update({
    where: { id: withdrawal.distributorId },
    data: {
      withdrawnAmount: { increment: 100 }  // 0 â†’ 100 ğŸ“Š
    }
  })

  // æ›´æ–°æç°è®°å½•çŠ¶æ€
  return tx.commissionWithdrawal.update({
    where: { id },
    data: {
      status: "completed",           // pending â†’ completed
      transactionId: "BANK_TX_123", // é“¶è¡Œè½¬è´¦å‡­è¯
      completedAt: new Date()
    }
  })
})
```

**çŠ¶æ€å˜åŒ–**ï¼š
```
totalEarnings:      100 (ä¸å˜)
pendingCommission:  0 (ä¸å˜)
availableBalance:   0 (ä¸å˜)
withdrawnAmount:    0 â†’ 100 ğŸ“Š (ä»…ç»Ÿè®¡ï¼Œå±•ç¤ºæ€»æç°é‡‘é¢)
```

ğŸ’¡ **è¿™é‡Œåªæ˜¯ç»Ÿè®¡è®°å½•**ï¼ŒçœŸå®è½¬è´¦ç”±ç®¡ç†å‘˜æ‰‹åŠ¨å®Œæˆ

---

### æç°åˆ’æ‰£æ¥æºæ€»ç»“

#### âœ… ç³»ç»Ÿå±‚é¢ï¼ˆæ•°æ®åº“ï¼‰
**ä» `Distributor.availableBalance` æ‰£é™¤**

- **æ‰£é™¤æ—¶æœº**ï¼šç”¨æˆ·æäº¤æç°ç”³è¯·çš„ç¬é—´
- **æ‰£é™¤ä½ç½®**ï¼š`app/api/distribution/withdrawals/route.ts:142`
- **ç›®çš„**ï¼šé˜²æ­¢é‡å¤æç°

#### ğŸ’µ å®é™…èµ„é‡‘å±‚é¢
**å¹³å°ä»è‡ªå·±çš„é“¶è¡Œè´¦æˆ·è½¬è´¦ç»™åˆ†é”€å•†**

ç³»ç»Ÿåªè´Ÿè´£ï¼š
1. **è®°å½•**æç°ç”³è¯·
2. **æ‰£é™¤**åˆ†é”€å•†çš„å¯æç°ä½™é¢ï¼ˆé˜²æ­¢é‡å¤æç°ï¼‰
3. **é€šçŸ¥**ç®¡ç†å‘˜æ‰“æ¬¾
4. ç®¡ç†å‘˜**æ‰‹åŠ¨**é€šè¿‡é“¶è¡Œè½¬è´¦
5. **æ›´æ–°**æç°è®°å½•çŠ¶æ€ä¸º"å·²å®Œæˆ"

---

### ç‰¹æ®Šåœºæ™¯å¤„ç†

#### åœºæ™¯ Aï¼šç”¨æˆ·åœ¨å†·é™æœŸå†…é€€æ¬¾
**è§¦å‘æ–‡ä»¶**ï¼š`app/api/orders/[id]/refund/route.ts`

```typescript
// ä½£é‡‘è¿˜åœ¨ pendingCommission ä¸­
await tx.distributor.update({
  where: { id: distributorId },
  data: {
    totalEarnings: { decrement: 100 },      // 100 â†’ 0
    pendingCommission: { decrement: 100 }   // 100 â†’ 0 âœ…
  }
})
```

**ç»“æœ**ï¼šâœ… è‡ªåŠ¨å¤„ç†ï¼Œæ— é£é™©

---

#### åœºæ™¯ Bï¼šç”¨æˆ·åœ¨ç»“ç®—åã€æç°å‰é€€æ¬¾
```typescript
// ä½£é‡‘åœ¨ availableBalance ä¸­
await tx.distributor.update({
  where: { id: distributorId },
  data: {
    totalEarnings: { decrement: 100 },      // 100 â†’ 0
    availableBalance: { decrement: 100 }    // 100 â†’ 0 âœ…
  }
})
```

**ç»“æœ**ï¼šâœ… è‡ªåŠ¨å¤„ç†ï¼Œä»å¯æç°ä½™é¢æ‰£é™¤

---

#### åœºæ™¯ Cï¼šç”¨æˆ·åœ¨æç°åé€€æ¬¾ï¼ˆå·²å®Œæˆæç°ï¼‰
```typescript
// ä½™é¢ä¸è¶³ï¼Œæ— æ³•æ‰£é™¤
if (distributor.availableBalance < commissionAmount) {
  // åˆ›å»ºå®‰å…¨è­¦æŠ¥
  await tx.securityAlert.create({
    type: "REFUND_COMMISSION_SHORTAGE",
    severity: "high",
    description: `è®¢å•é€€æ¬¾ä½†åˆ†é”€å•†ä½™é¢ä¸è¶³ã€‚éœ€è¿½è®¨ Â¥${shortage}`
  })
}
```

**ç»“æœ**ï¼šâš ï¸ åˆ›å»ºé«˜ä¼˜å…ˆçº§è­¦æŠ¥ï¼Œéœ€äººå·¥å¤„ç†ï¼ˆè”ç³»åˆ†é”€å•†è¿½è®¨ï¼‰

---

### å…³é”®è®¾è®¡åŸåˆ™

1. **ä¸‰å±‚ä½™é¢éš”ç¦»**
   - `pendingCommission`ï¼šå†·é™æœŸæš‚å­˜ï¼Œä¸å¯æç°
   - `availableBalance`ï¼šå¯æç°ä½™é¢ï¼Œæç°æ—¶æ‰£é™¤
   - `withdrawnAmount`ï¼šç»Ÿè®¡å­—æ®µï¼Œä»…ç”¨äºå±•ç¤º

2. **æå‰æ‰£é™¤æœºåˆ¶**
   - æç°ç”³è¯·æ—¶ç«‹å³æ‰£é™¤ `availableBalance`
   - é˜²æ­¢åŒä¸€ç¬”é’±é‡å¤æç°

3. **å†·é™æœŸä¿æŠ¤**
   - è®¢å•æ”¯ä»˜å15å¤©å†…ä¸ç»“ç®—åˆ°å¯æç°ä½™é¢
   - é™ä½é€€æ¬¾é£é™©

4. **å¼‚å¸¸å‘Šè­¦**
   - ä½™é¢ä¸è¶³æ—¶åˆ›å»ºè­¦æŠ¥
   - ä¾¿äºäººå·¥è¿½è®¨å’Œå®¡è®¡

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. è¿è¡Œé…ç½®åˆå§‹åŒ–

```bash
npx tsx scripts/init-withdrawal-configs.ts
```

è¿™ä¼šæ·»åŠ  `commission_settlement_cooldown_days` é…ç½®é¡¹ã€‚

### 2. é…ç½®å®šæ—¶ä»»åŠ¡

#### æ–¹å¼ Aï¼šVercel Cron Jobs

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `vercel.json`ï¼š

```json
{
  "crons": [{
    "path": "/api/cron/settle-commissions",
    "schedule": "0 2 * * *"
  }]
}
```

#### æ–¹å¼ Bï¼šå¤–éƒ¨ Cron æœåŠ¡

ä½¿ç”¨ [cron-job.org](https://cron-job.org) æˆ–ç±»ä¼¼æœåŠ¡ï¼š
- URL: `https://your-domain.com/api/cron/settle-commissions`
- æ‰§è¡Œæ—¶é—´: æ¯å¤©å‡Œæ™¨ 2:00

#### æ–¹å¼ Cï¼šæœåŠ¡å™¨ Cron Tab

```bash
crontab -e

# æ·»åŠ 
0 2 * * * curl https://your-domain.com/api/cron/settle-commissions
```

### 3. é…ç½®å†·é™æœŸå¤©æ•°ï¼ˆå¯é€‰ï¼‰

å†·é™æœŸå¤©æ•°é€šè¿‡é…ç½®é¡¹ `commission_settlement_cooldown_days` æ§åˆ¶ã€‚æœ‰ä»¥ä¸‹å‡ ç§é…ç½®æ–¹æ³•ï¼š

#### æ–¹æ³• 1ï¼šé€šè¿‡åå°ç®¡ç†ç•Œé¢é…ç½®ï¼ˆæ¨èï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šç®¡ç†å‘˜éœ€è¦å¿«é€Ÿè°ƒæ•´å†·é™æœŸï¼Œæ— éœ€æŠ€æœ¯æ“ä½œ

**è®¿é—®è·¯å¾„**ï¼š`/backendmanager/distribution/withdrawal-config`

**æ“ä½œæ­¥éª¤**ï¼š
1. ä½¿ç”¨ç®¡ç†å‘˜è´¦å·ç™»å½•ç³»ç»Ÿ
2. è®¿é—®"åå°ç®¡ç†" â†’ "åˆ†é”€ç®¡ç†" â†’ "æç°å®¡æ ¸é…ç½®"
3. åœ¨"åŸºç¡€é…ç½®"åŒºå—æ‰¾åˆ°"ä½£é‡‘ç»“ç®—å†·é™æœŸ"è®¾ç½®
4. ä¿®æ”¹å¤©æ•°ï¼ˆå»ºè®®ï¼š7-30å¤©ï¼‰
5. ç‚¹å‡»"ä¿å­˜æ‰€æœ‰é…ç½®"æŒ‰é’®

**ä¼˜ç‚¹**ï¼š
- âœ… å¯è§†åŒ–ç•Œé¢ï¼Œæ“ä½œç®€å•
- âœ… å®æ—¶ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯
- âœ… è‡ªåŠ¨éªŒè¯è¾“å…¥å€¼
- âœ… æœ‰é…ç½®æ‘˜è¦å±•ç¤º

---

#### æ–¹æ³• 2ï¼šé€šè¿‡æ•°æ®åº“ç›´æ¥ä¿®æ”¹

**é€‚ç”¨åœºæ™¯**ï¼šæ‰¹é‡åˆå§‹åŒ–ã€è„šæœ¬åŒ–éƒ¨ç½²

**SQL å‘½ä»¤**ï¼š
```sql
-- æŸ¥çœ‹å½“å‰é…ç½®
SELECT * FROM SystemConfig
WHERE key = 'commission_settlement_cooldown_days';

-- ä¿®æ”¹å†·é™æœŸä¸º 30 å¤©
UPDATE SystemConfig
SET value = '30'
WHERE key = 'commission_settlement_cooldown_days';
```

**æ³¨æ„äº‹é¡¹**ï¼š
- âš ï¸ éœ€è¦æ•°æ®åº“è®¿é—®æƒé™
- âš ï¸ è¾“å…¥å€¼å¿…é¡»æ˜¯æ•°å­—å­—ç¬¦ä¸²
- âš ï¸ ä¿®æ”¹åç«‹å³ç”Ÿæ•ˆ

---

#### æ–¹æ³• 3ï¼šé€šè¿‡ API æ¥å£ä¿®æ”¹

**é€‚ç”¨åœºæ™¯**ï¼šè‡ªåŠ¨åŒ–è¿ç»´ã€é›†æˆç¬¬ä¸‰æ–¹ç³»ç»Ÿ

**API ç«¯ç‚¹**ï¼š`PUT /api/backendmanager/withdrawal-config`

**è¯·æ±‚ç¤ºä¾‹**ï¼š
```bash
curl -X PUT https://your-domain.com/api/backendmanager/withdrawal-config \
  -H "Content-Type: application/json" \
  -H "Cookie: next-auth.session-token=YOUR_SESSION_TOKEN" \
  -d '{
    "configs": [
      {
        "key": "commission_settlement_cooldown_days",
        "value": "30",
        "type": "number"
      }
    ]
  }'
```

**æƒé™è¦æ±‚**ï¼š
- éœ€è¦ç™»å½•ä¸”æ‹¥æœ‰ `DISTRIBUTION` æ¨¡å—çš„ `WRITE` æƒé™
- æˆ–è€…æ˜¯ç³»ç»Ÿç®¡ç†å‘˜ï¼ˆ`ADMIN` è§’è‰²ï¼‰

---

#### æ–¹æ³• 4ï¼šä¿®æ”¹åˆå§‹åŒ–è„šæœ¬é»˜è®¤å€¼

**é€‚ç”¨åœºæ™¯**ï¼šæ–°ç¯å¢ƒéƒ¨ç½²ã€é‡ç½®é…ç½®

**æ–‡ä»¶è·¯å¾„**ï¼š`scripts/init-withdrawal-configs.ts`

**ä¿®æ”¹æ–¹æ³•**ï¼š
```typescript
// æ‰¾åˆ°è¿™ä¸€æ®µé…ç½®
{
  key: "commission_settlement_cooldown_days",
  value: "15",  // ä¿®æ”¹è¿™é‡Œçš„é»˜è®¤å€¼
  type: "number",
  category: "withdrawal",
  description: "ä½£é‡‘ç»“ç®—å†·é™æœŸï¼ˆå¤©ï¼‰ï¼Œè®¢å•æ”¯ä»˜åéœ€ç­‰å¾…æ­¤æœŸé™æ‰èƒ½ç»“ç®—ä½£é‡‘ï¼Œé˜²æ­¢é€€æ¬¾é£é™©"
}
```

**æ‰§è¡Œè„šæœ¬**ï¼š
```bash
npx tsx scripts/init-withdrawal-configs.ts
```

**æ³¨æ„äº‹é¡¹**ï¼š
- âš ï¸ æ­¤æ–¹æ³•ä¼šé‡ç½®æ‰€æœ‰æç°é…ç½®ä¸ºé»˜è®¤å€¼
- âš ï¸ é€‚åˆé¦–æ¬¡éƒ¨ç½²æˆ–å®Œå…¨é‡ç½®é…ç½®

---

### é…ç½®å»ºè®®

æ ¹æ®ä¸åŒä¸šåŠ¡åœºæ™¯ï¼Œæ¨èä»¥ä¸‹å†·é™æœŸè®¾ç½®ï¼š

| ä¸šåŠ¡ç±»å‹ | æ¨èå¤©æ•° | è¯´æ˜ |
|---------|---------|------|
| è™šæ‹Ÿå•†å“/è¯¾ç¨‹ | 7-10 å¤© | è™šæ‹Ÿå•†å“æ— ç‰©æµå»¶è¿Ÿï¼Œå¯é€‚å½“ç¼©çŸ­ |
| å®ç‰©å•†å“ | 15-20 å¤© | è€ƒè™‘ç‰©æµæ—¶é—´å’Œä¸ƒå¤©æ— ç†ç”±é€€è´§ |
| é«˜ä»·å€¼å•†å“ | 20-30 å¤© | é«˜ä»·å•†å“é€€æ¬¾é£é™©å¤§ï¼Œå»¶é•¿ä¿æŠ¤æœŸ |
| é¢„å”®å•†å“ | 30+ å¤© | é¢„å”®å•†å“å‘è´§å‘¨æœŸé•¿ï¼Œéœ€æ›´é•¿ä¿æŠ¤ |

**é‡è¦æç¤º**ï¼š
- ğŸ” å†·é™æœŸè¶Šé•¿ï¼Œå®‰å…¨æ€§è¶Šé«˜ï¼Œä½†åˆ†é”€å•†ä½“éªŒè¶Šå·®
- âš¡ å†·é™æœŸè¶ŠçŸ­ï¼Œåˆ†é”€å•†æ»¡æ„åº¦è¶Šé«˜ï¼Œä½†é€€æ¬¾é£é™©è¶Šå¤§
- ğŸ¯ å»ºè®®æ ¹æ®å†å²é€€æ¬¾ç‡åŠ¨æ€è°ƒæ•´ï¼Œå¹³è¡¡å®‰å…¨ä¸ä½“éªŒ

**é…ç½®ç”Ÿæ•ˆæ—¶é—´**ï¼š
- ä¿®æ”¹é…ç½®å**ç«‹å³ç”Ÿæ•ˆ**ï¼Œæ— éœ€é‡å¯æœåŠ¡
- å·²ç»è¿›å…¥å†·é™æœŸçš„è®¢å•æŒ‰**æ—§é…ç½®**è®¡ç®—
- æ–°è®¢å•æŒ‰**æ–°é…ç½®**è®¡ç®—å†·é™æœŸ

## ğŸ“ˆ ç›‘æ§å’Œç»´æŠ¤

### éœ€è¦ç›‘æ§çš„æŒ‡æ ‡

1. **å¾…ç»“ç®—ä½£é‡‘æ€»é¢**
   ```sql
   SELECT SUM(pendingCommission) FROM Distributor;
   ```

2. **å†·é™æœŸè®¢å•æ•°é‡**
   ```sql
   SELECT COUNT(*) FROM DistributionOrder
   WHERE status = 'confirmed';
   ```

3. **è‡ªåŠ¨ç»“ç®—æˆåŠŸç‡**
   - æ£€æŸ¥å®šæ—¶ä»»åŠ¡æ—¥å¿—
   - ç¡®ä¿æ¯å¤©éƒ½æœ‰æ‰§è¡Œ

4. **é€€æ¬¾è­¦æŠ¥**
   ```sql
   SELECT * FROM SecurityAlert
   WHERE type = 'REFUND_COMMISSION_SHORTAGE'
   AND status = 'pending';
   ```

### å¸¸è§é—®é¢˜å¤„ç†

**Q: ä½£é‡‘ä¸€ç›´ä¸ç»“ç®—ï¼Ÿ**
- æ£€æŸ¥å®šæ—¶ä»»åŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
- æ‰‹åŠ¨è®¿é—® `/api/cron/settle-commissions` è§¦å‘ç»“ç®—

**Q: é€€æ¬¾æ—¶ä½™é¢ä¸è¶³æ€ä¹ˆåŠï¼Ÿ**
- ç³»ç»Ÿä¼šåˆ›å»ºé«˜ä¼˜å…ˆçº§å®‰å…¨è­¦æŠ¥
- éœ€è¦äººå·¥è”ç³»åˆ†é”€å•†å¤„ç†
- å¯ä»¥ä»æœªæ¥ä½£é‡‘ä¸­æ‰£é™¤

**Q: å†·é™æœŸè®¾ç½®å¤šå°‘å¤©åˆé€‚ï¼Ÿ**
- å»ºè®® 15-30 å¤©
- éœ€è¦å¹³è¡¡å¹³å°å®‰å…¨æ€§å’Œåˆ†é”€å•†ä½“éªŒ
- å¯ä»¥å‚è€ƒç”µå•†å¹³å°çš„é€€æ¬¾æœŸé™

## ğŸ”’ å®‰å…¨ä¼˜åŠ¿

### é˜²æŠ¤æ•ˆæœ

âœ… **é˜²æ­¢æ¶æ„å¥—ç°**ï¼šå†·é™æœŸå†…æ— æ³•æç°ï¼Œé€€æ¬¾ä¼šè‡ªåŠ¨å–æ¶ˆä½£é‡‘

âœ… **é™ä½å¹³å°æŸå¤±**ï¼šå¤§éƒ¨åˆ†é€€æ¬¾å‘ç”Ÿåœ¨7å¤©å†…ï¼Œ15å¤©å†·é™æœŸå¯è¦†ç›–å¤§éƒ¨åˆ†é£é™©åœºæ™¯

âœ… **è‡ªåŠ¨åŒ–å¤„ç†**ï¼šæ— éœ€äººå·¥å¹²é¢„ï¼Œç³»ç»Ÿè‡ªåŠ¨ç»“ç®—å’Œå–æ¶ˆ

âœ… **å¼‚å¸¸è­¦æŠ¥**ï¼šç‰¹æ®Šæƒ…å†µï¼ˆä½™é¢ä¸è¶³ï¼‰ä¼šåˆ›å»ºè­¦æŠ¥ï¼Œä¾¿äºäººå·¥å¤„ç†

### ä¸å…¶ä»–æœºåˆ¶é…åˆ

å¯ä»¥ç»“åˆæç°é£æ§ç³»ç»Ÿä½¿ç”¨ï¼š
- é¦–æ¬¡æç°éœ€äººå·¥å®¡æ ¸
- å¤§é¢æç°éœ€äººå·¥å®¡æ ¸
- æ–°æ³¨å†Œåˆ†é”€å•†éœ€ç­‰å¾…æ›´é•¿æ—¶é—´

ä¸¤è€…é…åˆå½¢æˆå¤šå±‚é˜²æŠ¤ä½“ç³»ã€‚

## ğŸ“ æ€»ç»“

é€šè¿‡å®æ–½ä½£é‡‘ç»“ç®—å†·é™æœŸæœºåˆ¶ï¼š
1. âœ… æœ‰æ•ˆé˜²æ­¢äº†åˆ†é”€å•†ä¸ä¹°å®¶å‹¾ç»“å¥—ç°çš„é£é™©
2. âœ… é™ä½äº†é€€æ¬¾åœºæ™¯ä¸‹å¹³å°çš„èµ„é‡‘æŸå¤±
3. âœ… å®ç°äº†è‡ªåŠ¨åŒ–å¤„ç†ï¼Œå‡å°‘äººå·¥æˆæœ¬
4. âœ… æä¾›äº†å®Œå–„çš„ç›‘æ§å’Œè­¦æŠ¥æœºåˆ¶

è¿™æ˜¯åˆ†é”€ç³»ç»Ÿä¸­ä¸€ä¸ª**éå¸¸é‡è¦çš„å®‰å…¨æœºåˆ¶**ï¼Œå¼ºçƒˆå»ºè®®å¯ç”¨ã€‚
æˆ‘å·²ç»æˆåŠŸå®ç°äº†å®Œæ•´çš„å®‰å…¨é˜²æŠ¤æ–¹æ¡ˆï¼Œå½»åº•è§£å†³äº†ä½ æ‹…å¿ƒçš„é€€æ¬¾é£é™©æ¼æ´ï¼

ğŸ” é—®é¢˜å·²è§£å†³
åŸæœ‰æ¼æ´
âŒ ç”¨æˆ·è´­ä¹° â†’ ä½£é‡‘ç«‹å³å¯æç° â†’ åˆ†é”€å•†æç° â†’ ç”¨æˆ·é€€æ¬¾ â†’ å¹³å°æŸå¤±

ç°åœ¨çš„å®‰å…¨æœºåˆ¶
âœ… ç”¨æˆ·è´­ä¹° â†’ ä½£é‡‘è¿›å…¥15å¤©å†·é™æœŸ â†’ æ— é€€æ¬¾æ‰å¯æç° â†’ é˜²æ­¢å¥—ç°

ğŸ“¦ å®ç°çš„åŠŸèƒ½
1. ä½£é‡‘ç»“ç®—å†·é™æœŸï¼ˆ15å¤©ï¼Œå¯é…ç½®ï¼‰
è®¢å•æ”¯ä»˜æˆåŠŸ
    â†“
ä½£é‡‘çŠ¶æ€: confirmed (å·²ç¡®è®¤ï¼Œä½†ä¸å¯æç°)
ä½£é‡‘æš‚å­˜: pendingCommission (å¾…ç»“ç®—ä½£é‡‘) â³
    â†“
ç­‰å¾… 15 å¤©
    â†“
ã€æƒ…å†µAã€‘æ— é€€æ¬¾ â†’ è‡ªåŠ¨ç»“ç®—åˆ° availableBalance (å¯æç°) âœ…
ã€æƒ…å†µBã€‘æœ‰é€€æ¬¾ â†’ è‡ªåŠ¨å–æ¶ˆä½£é‡‘ âŒ

2. è‡ªåŠ¨ç»“ç®—å®šæ—¶ä»»åŠ¡
API: /api/cron/settle-commissions
åŠŸèƒ½ï¼šæ¯å¤©è‡ªåŠ¨æ£€æŸ¥å¹¶ç»“ç®—è¶…è¿‡å†·é™æœŸçš„ä½£é‡‘
ä½¿ç”¨ï¼šé…ç½® cron job æ¯å¤©æ‰§è¡Œ
3. æ™ºèƒ½é€€æ¬¾å¤„ç†
API: /api/orders/[id]/refund
å†·é™æœŸå†…é€€æ¬¾ï¼šä»å¾…ç»“ç®—ä½£é‡‘ä¸­æ‰£é™¤ âœ…
å·²ç»“ç®—åé€€æ¬¾ï¼ˆä½™é¢å……è¶³ï¼‰ï¼šä»å¯æç°ä½™é¢ä¸­æ‰£é™¤ âœ…
å·²ç»“ç®—åé€€æ¬¾ï¼ˆå·²æç°ï¼‰ï¼šåˆ›å»ºé«˜ä¼˜å…ˆçº§è­¦æŠ¥ï¼Œéœ€äººå·¥å¤„ç† âš ï¸
4. ç”¨æˆ·æç¤º
åˆ†é”€ä¸­å¿ƒé¡µé¢æ–°å¢è¯´æ˜ï¼š

â³ **å¾…ç»“ç®—ä½£é‡‘è¯´æ˜ï¼š**è®¢å•æ”¯ä»˜æˆåŠŸåï¼Œä½£é‡‘ä¼šè¿›å…¥15å¤©çš„ç»“ç®—å†·é™æœŸï¼ŒæœŸé—´å¦‚æœè®¢å•é€€æ¬¾ï¼Œä½£é‡‘å°†è‡ªåŠ¨å–æ¶ˆã€‚è¶…è¿‡å†·é™æœŸåï¼Œä½£é‡‘ä¼šè‡ªåŠ¨è½¬å…¥å¯æç°ä½™é¢ã€‚

ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶
æ ¸å¿ƒé€»è¾‘
âœ… app/api/payment/callback/route.ts - é€šç”¨æ”¯ä»˜å›è°ƒ
âœ… app/api/payment/callback/wechat/route.ts - å¾®ä¿¡æ”¯ä»˜
âœ… app/api/payment/callback/alipay/route.ts - æ”¯ä»˜å®
âœ… app/api/payment/callback/paypal/route.ts - PayPal
æ–°å¢åŠŸèƒ½
âœ… app/api/cron/settle-commissions/route.ts - è‡ªåŠ¨ç»“ç®—ä»»åŠ¡
âœ… app/api/orders/[id]/refund/route.ts - é€€æ¬¾å¤„ç†
âœ… docs/commission-settlement-cooldown.md - å®Œæ•´æ–‡æ¡£
é…ç½®å’Œå‰ç«¯
âœ… scripts/init-withdrawal-configs.ts - æ·»åŠ å†·é™æœŸé…ç½®
âœ… app/distribution/page.tsx - æ·»åŠ å†·é™æœŸæç¤º
ğŸš€ éƒ¨ç½²æ­¥éª¤
1. åˆå§‹åŒ–é…ç½®
npx tsx scripts/init-withdrawal-configs.ts

2. é…ç½®å®šæ—¶ä»»åŠ¡ï¼ˆé€‰æ‹©ä¸€ç§ï¼‰
æ–¹å¼ Aï¼šVercel Cron Jobsï¼ˆæ¨èï¼‰ åœ¨ vercel.json æ·»åŠ ï¼š

{
  "crons": [{
    "path": "/api/cron/settle-commissions",
    "schedule": "0 2 * * *"
  }]
}

æ–¹å¼ Bï¼šå¤–éƒ¨ Cron æœåŠ¡ ä½¿ç”¨ cron-job.orgï¼Œæ¯å¤©å‡Œæ™¨2ç‚¹è®¿é—®ï¼š

https://your-domain.com/api/cron/settle-commissions

ğŸ›¡ï¸ å®‰å…¨ä¼˜åŠ¿
åœºæ™¯	æ—§ç³»ç»Ÿ	æ–°ç³»ç»Ÿ
æ¶æ„å¥—ç°	âŒ å¯ç«‹å³æç°åé€€æ¬¾	âœ… å†·é™æœŸå†…æ— æ³•æç°
æ­£å¸¸é€€è´§	âŒ å¹³å°æ‰¿æ‹…ä½£é‡‘æŸå¤±	âœ… è‡ªåŠ¨å–æ¶ˆä½£é‡‘
å·²æç°çš„é€€æ¬¾	âŒ æ— æ³•å¤„ç†	âœ… åˆ›å»ºè­¦æŠ¥ï¼Œäººå·¥è¿½è®¨
ğŸ“Š ç›‘æ§å»ºè®®
æŸ¥çœ‹å¾…ç»“ç®—ä½£é‡‘æ€»é¢ï¼š

SELECT SUM(pendingCommission) FROM Distributor;

æŸ¥çœ‹éœ€è¦äººå·¥å¤„ç†çš„é€€æ¬¾è­¦æŠ¥ï¼š

SELECT * FROM SecurityAlert
WHERE type = 'REFUND_COMMISSION_SHORTAGE'
AND status = 'pending';

æ‰€æœ‰æ›´æ”¹å·²æäº¤åˆ°åˆ†æ”¯ claude/add-withdrawal-button-01P97JwBwSNEJMbaZXYjmci1ï¼ŒåŒ…æ‹¬ï¼š

âœ… åˆ†é”€ä¸­å¿ƒæ·»åŠ æç°æŒ‰é’®
âœ… å®ç°ä½£é‡‘ç»“ç®—å†·é™æœŸæœºåˆ¶
âœ… å®Œæ•´çš„é€€æ¬¾å¤„ç†é€»è¾‘
âœ… è‡ªåŠ¨ç»“ç®—å®šæ—¶ä»»åŠ¡
âœ… è¯¦ç»†çš„æ–‡æ¡£è¯´æ˜
è¿™ä¸ªå®‰å…¨æœºåˆ¶èƒ½æœ‰æ•ˆé˜²æ­¢ä½ æ‹…å¿ƒçš„é€€æ¬¾é£é™©æ¼æ´ï¼ğŸ‰

è¿™ä¸ªâ€œå†·é™æœŸâ€è®¾è®¡è®°å¾—å†™å…¥æ–‡æ¡£ï¼Œå¹¶æäº¤GitHub

å¥½çš„ï¼å®é™…ä¸Šæˆ‘å·²ç»å®Œæˆäº†æ–‡æ¡£çš„ç¼–å†™å’Œæäº¤ã€‚è®©æˆ‘ç¡®è®¤ä¸€ä¸‹ï¼š

Bash
git log --oneline -3
88b3d0c feat: å®ç°ä½£é‡‘ç»“ç®—å†·é™æœŸæœºåˆ¶ï¼Œé˜²æ­¢é€€æ¬¾é£é™©æ¼æ´
2c505cd feat: åœ¨åˆ†é”€ä¸­å¿ƒæ·»åŠ é†’ç›®çš„æç°æŒ‰é’®
260af58 Merge pull request #66 from linqiluo8-design/claude/fix-chat-image-upload-01NHPyzWaNjfjD9a4jwzYBBB
Bash
git show 88b3d0c --stat | grep -E "(docs|md)"
- æ–°å¢ï¼šdocs/commission-settlement-cooldown.md
    3. è¯¦è§æ–‡æ¡£ï¼šdocs/commission-settlement-cooldown.md
 docs/commission-settlement-cooldown.md   | 345 +++++++++++++++++++++++++++++++
Bash
git log --oneline origin/claude/add-withdrawal-button-01P97JwBwSNEJMbaZXYjmci1 -1
88b3d0c feat: å®ç°ä½£é‡‘ç»“ç®—å†·é™æœŸæœºåˆ¶ï¼Œé˜²æ­¢é€€æ¬¾é£é™©æ¼æ´
âœ… å·²å®Œæˆï¼ å†·é™æœŸæœºåˆ¶çš„å®Œæ•´æ–‡æ¡£å·²ç»ç¼–å†™å¹¶æäº¤åˆ° GitHubã€‚

ğŸ“„ å·²æäº¤çš„æ–‡æ¡£
æ–‡æ¡£ä½ç½®ï¼šdocs/commission-settlement-cooldown.md

å†…å®¹åŒ…æ‹¬ï¼š

ğŸ“‹ é—®é¢˜èƒŒæ™¯å’Œå®‰å…¨æ¼æ´åˆ†æ
âœ… å»¶è¿Ÿç»“ç®—æœºåˆ¶çš„è§£å†³æ–¹æ¡ˆ
ğŸ”§ è¯¦ç»†çš„æŠ€æœ¯å®ç°è¯´æ˜
ğŸ“Š ä½£é‡‘çŠ¶æ€æµè½¬å›¾
ğŸš€ å®Œæ•´çš„éƒ¨ç½²æ­¥éª¤
ğŸ“ˆ ç›‘æ§å’Œç»´æŠ¤æŒ‡å—
ğŸ”’ å®‰å…¨ä¼˜åŠ¿åˆ†æ
ğŸ“¦ Git æäº¤è®°å½•
commit 88b3d0c
feat: å®ç°ä½£é‡‘ç»“ç®—å†·é™æœŸæœºåˆ¶ï¼Œé˜²æ­¢é€€æ¬¾é£é™©æ¼æ´

ä¸»è¦æ”¹åŠ¨ï¼š
âœ… æ–°å¢å®Œæ•´æ–‡æ¡£ï¼šdocs/commission-settlement-cooldown.md (345è¡Œ)
âœ… ä¿®æ”¹æ”¯ä»˜å›è°ƒï¼šä½£é‡‘è®¾ä¸º confirmed è€Œé settled
âœ… æ–°å¢è‡ªåŠ¨ç»“ç®—ä»»åŠ¡ï¼šapp/api/cron/settle-commissions/route.ts
âœ… æ–°å¢é€€æ¬¾å¤„ç†ï¼šapp/api/orders/[id]/refund/route.ts
âœ… æ·»åŠ å†·é™æœŸé…ç½®ï¼šcommission_settlement_cooldown_days
âœ… å‰ç«¯æ·»åŠ ç”¨æˆ·æç¤º

---

**ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-11-30
**ä½œè€…**: Claude Code
