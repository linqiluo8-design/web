# æ”¯ä»˜æ¥å£é…ç½®åŠŸèƒ½è®¾è®¡æ–‡æ¡£

## 1. æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†è™šæ‹Ÿå•†å“å”®å–å¹³å°çš„æ”¯ä»˜æ¥å£é…ç½®åŠŸèƒ½è®¾è®¡ï¼ŒåŒ…æ‹¬æ”¯ä»˜å®ã€å¾®ä¿¡æ”¯ä»˜ã€PayPalä¸‰ç§æ”¯ä»˜æ–¹å¼çš„é…ç½®ç®¡ç†ï¼Œä»¥åŠæ¨¡æ‹Ÿæ”¯ä»˜/çœŸå®æ”¯ä»˜æ¨¡å¼åˆ‡æ¢åŠŸèƒ½ã€‚

### 1.1 åŠŸèƒ½ç›®æ ‡

1. **æ”¯ä»˜æ¥å£é…ç½®ç®¡ç†**ï¼šç®¡ç†å‘˜å¯ä»¥åœ¨åå°é…ç½®æ”¯ä»˜å®ã€å¾®ä¿¡æ”¯ä»˜ã€PayPalçš„å•†æˆ·ä¿¡æ¯
2. **æ¨¡æ‹Ÿ/çœŸå®æ”¯ä»˜åˆ‡æ¢**ï¼šæä¾›å¼€å…³æ§åˆ¶ä½¿ç”¨æ¨¡æ‹Ÿæ”¯ä»˜è¿˜æ˜¯çœŸå®æ”¯ä»˜æ¥å£
3. **æ”¯ä»˜æ–¹å¼å¯ç”¨æ§åˆ¶**ï¼šç‹¬ç«‹æ§åˆ¶æ¯ç§æ”¯ä»˜æ–¹å¼çš„å¯ç”¨/åœç”¨çŠ¶æ€
4. **å®‰å…¨æ€§ä¿éšœ**ï¼šæ•æ„Ÿé…ç½®ä¿¡æ¯åŠ å¯†å­˜å‚¨ï¼Œä»…ç®¡ç†å‘˜å¯è®¿é—®

### 1.2 é€‚ç”¨åœºæ™¯

- **å¼€å‘/æµ‹è¯•ç¯å¢ƒ**ï¼šä½¿ç”¨æ¨¡æ‹Ÿæ”¯ä»˜ï¼Œæ— éœ€é…ç½®çœŸå®å•†æˆ·ä¿¡æ¯
- **æ¼”ç¤ºç¯å¢ƒ**ï¼šä½¿ç”¨æ¨¡æ‹Ÿæ”¯ä»˜å±•ç¤ºç³»ç»ŸåŠŸèƒ½
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šä½¿ç”¨çœŸå®æ”¯ä»˜æ¥å£ï¼Œå®Œæˆå®é™…äº¤æ˜“

---

## 2. æ•°æ®åº“è®¾è®¡

### 2.1 SystemConfig è¡¨æ‰©å±•

åˆ©ç”¨ç°æœ‰çš„ `SystemConfig` è¡¨å­˜å‚¨æ”¯ä»˜ç›¸å…³é…ç½®ã€‚

#### 2.1.1 æ”¯ä»˜æ¨¡å¼é…ç½®

| key | value | type | category | description |
|-----|-------|------|----------|-------------|
| `payment_mode` | `"mock"` / `"real"` | string | payment | æ”¯ä»˜æ¨¡å¼ï¼šmock=æ¨¡æ‹Ÿæ”¯ä»˜ï¼Œreal=çœŸå®æ”¯ä»˜ |
| `payment_alipay_enabled` | `"true"` / `"false"` | boolean | payment | æ˜¯å¦å¯ç”¨æ”¯ä»˜å®æ”¯ä»˜ |
| `payment_wechat_enabled` | `"true"` / `"false"` | boolean | payment | æ˜¯å¦å¯ç”¨å¾®ä¿¡æ”¯ä»˜ |
| `payment_paypal_enabled` | `"true"` / `"false"` | boolean | payment | æ˜¯å¦å¯ç”¨PayPalæ”¯ä»˜ |

#### 2.1.2 æ”¯ä»˜å®é…ç½®

| key | value | type | category | description |
|-----|-------|------|----------|-------------|
| `alipay_app_id` | åº”ç”¨ID | string | payment | æ”¯ä»˜å®å¼€æ”¾å¹³å°åº”ç”¨APPID |
| `alipay_private_key` | RSAç§é’¥ | string | payment | åº”ç”¨ç§é’¥ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰ |
| `alipay_public_key` | æ”¯ä»˜å®å…¬é’¥ | string | payment | æ”¯ä»˜å®å…¬é’¥ |
| `alipay_gateway` | ç½‘å…³URL | string | payment | æ”¯ä»˜å®ç½‘å…³åœ°å€ï¼ˆé»˜è®¤ï¼šhttps://openapi.alipay.com/gateway.doï¼‰ |
| `alipay_notify_url` | å¼‚æ­¥é€šçŸ¥URL | string | payment | æ”¯ä»˜å®å¼‚æ­¥é€šçŸ¥åœ°å€ |
| `alipay_return_url` | åŒæ­¥è·³è½¬URL | string | payment | æ”¯ä»˜å®åŒæ­¥è·³è½¬åœ°å€ |

#### 2.1.3 å¾®ä¿¡æ”¯ä»˜é…ç½®

| key | value | type | category | description |
|-----|-------|------|----------|-------------|
| `wechat_app_id` | åº”ç”¨ID | string | payment | å¾®ä¿¡å¼€æ”¾å¹³å°åº”ç”¨AppID |
| `wechat_mch_id` | å•†æˆ·å· | string | payment | å¾®ä¿¡æ”¯ä»˜å•†æˆ·å· |
| `wechat_api_key` | APIå¯†é’¥ | string | payment | å¾®ä¿¡æ”¯ä»˜APIå¯†é’¥ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰ |
| `wechat_cert_path` | è¯ä¹¦è·¯å¾„ | string | payment | å•†æˆ·è¯ä¹¦æ–‡ä»¶è·¯å¾„ï¼ˆå¯é€‰ï¼‰ |
| `wechat_notify_url` | å¼‚æ­¥é€šçŸ¥URL | string | payment | å¾®ä¿¡æ”¯ä»˜å¼‚æ­¥é€šçŸ¥åœ°å€ |

#### 2.1.4 PayPal é…ç½®

| key | value | type | category | description |
|-----|-------|------|----------|-------------|
| `paypal_client_id` | å®¢æˆ·ç«¯ID | string | payment | PayPalåº”ç”¨Client ID |
| `paypal_client_secret` | å®¢æˆ·ç«¯å¯†é’¥ | string | payment | PayPalåº”ç”¨Client Secretï¼ˆåŠ å¯†å­˜å‚¨ï¼‰ |
| `paypal_mode` | `"sandbox"` / `"live"` | string | payment | PayPalç¯å¢ƒï¼šsandbox=æ²™ç®±ï¼Œlive=ç”Ÿäº§ |
| `paypal_notify_url` | é€šçŸ¥URL | string | payment | PayPal IPNé€šçŸ¥åœ°å€ |
| `paypal_return_url` | è¿”å›URL | string | payment | æ”¯ä»˜æˆåŠŸè¿”å›åœ°å€ |
| `paypal_cancel_url` | å–æ¶ˆURL | string | payment | æ”¯ä»˜å–æ¶ˆè¿”å›åœ°å€ |

---

## 3. åç«¯APIè®¾è®¡

### 3.1 ç³»ç»Ÿé…ç½®ç®¡ç†API

#### 3.1.1 è·å–æ”¯ä»˜é…ç½®ï¼ˆç®¡ç†å‘˜ï¼‰

**è·¯å¾„**ï¼š`GET /api/backendmanager/system-config/payment`

**æƒé™**ï¼šä»… ADMIN

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "mode": "mock",
  "alipay": {
    "enabled": true,
    "configured": false,
    "config": {
      "app_id": "",
      "gateway": "https://openapi.alipay.com/gateway.do",
      "notify_url": "https://yourdomain.com/api/payment/callback/alipay",
      "return_url": "https://yourdomain.com/payment/callback/alipay"
    }
  },
  "wechat": {
    "enabled": true,
    "configured": false,
    "config": {
      "app_id": "",
      "mch_id": "",
      "notify_url": "https://yourdomain.com/api/payment/callback/wechat"
    }
  },
  "paypal": {
    "enabled": true,
    "configured": false,
    "config": {
      "client_id": "",
      "mode": "sandbox",
      "notify_url": "https://yourdomain.com/api/payment/callback/paypal",
      "return_url": "https://yourdomain.com/payment/success",
      "cancel_url": "https://yourdomain.com/payment/cancel"
    }
  }
}
```

#### 3.1.2 æ›´æ–°æ”¯ä»˜é…ç½®ï¼ˆç®¡ç†å‘˜ï¼‰

**è·¯å¾„**ï¼š`PUT /api/backendmanager/system-config/payment`

**æƒé™**ï¼šä»… ADMIN

**è¯·æ±‚ä½“ç¤ºä¾‹**ï¼š
```json
{
  "mode": "real",
  "alipay": {
    "enabled": true,
    "app_id": "2021xxxxxxxxxx",
    "private_key": "MIIEvQIBADANBg...",
    "public_key": "MIIBIjANBgkq...",
    "gateway": "https://openapi.alipay.com/gateway.do"
  },
  "wechat": {
    "enabled": true,
    "app_id": "wx1234567890",
    "mch_id": "1234567890",
    "api_key": "your_api_key_here"
  },
  "paypal": {
    "enabled": false
  }
}
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "message": "æ”¯ä»˜é…ç½®å·²æ›´æ–°"
}
```

#### 3.1.3 æµ‹è¯•æ”¯ä»˜é…ç½®

**è·¯å¾„**ï¼š`POST /api/backendmanager/system-config/payment/test`

**æƒé™**ï¼šä»… ADMIN

**è¯·æ±‚ä½“**ï¼š
```json
{
  "provider": "alipay" // "alipay" | "wechat" | "paypal"
}
```

**åŠŸèƒ½**ï¼šéªŒè¯æ”¯ä»˜é…ç½®æ˜¯å¦æ­£ç¡®ï¼ˆå¦‚æµ‹è¯•APIè¿æ¥ã€éªŒè¯å¯†é’¥ç­‰ï¼‰

**å“åº”**ï¼š
```json
{
  "success": true,
  "message": "æ”¯ä»˜å®é…ç½®æµ‹è¯•æˆåŠŸ",
  "details": {
    "api_accessible": true,
    "credentials_valid": true
  }
}
```

### 3.2 æ”¯ä»˜åˆ›å»ºAPIæ”¹é€ 

**è·¯å¾„**ï¼š`POST /api/payment/create`

**æ”¹é€ å†…å®¹**ï¼š

```typescript
export async function POST(request: Request) {
  try {
    const body = await request.json()
    const data = paymentSchema.parse(body)

    // 1. è·å–æ”¯ä»˜æ¨¡å¼é…ç½®
    const paymentMode = await getSystemConfig("payment_mode", "mock")

    // 2. æ£€æŸ¥æ”¯ä»˜æ–¹å¼æ˜¯å¦å¯ç”¨
    const providerEnabled = await getSystemConfig(
      `payment_${data.paymentMethod}_enabled`,
      "true"
    )

    if (providerEnabled !== "true") {
      return NextResponse.json(
        { error: "è¯¥æ”¯ä»˜æ–¹å¼æš‚æœªå¼€æ”¾" },
        { status: 400 }
      )
    }

    // 3. åˆ›å»ºæ”¯ä»˜è®°å½•
    const payment = await createPaymentRecord(data)

    // 4. æ ¹æ®æ”¯ä»˜æ¨¡å¼ç”Ÿæˆæ”¯ä»˜é“¾æ¥
    if (paymentMode === "mock") {
      // æ¨¡æ‹Ÿæ”¯ä»˜
      return generateMockPaymentUrl(payment, data)
    } else {
      // çœŸå®æ”¯ä»˜
      return generateRealPaymentUrl(payment, data)
    }

  } catch (error) {
    // é”™è¯¯å¤„ç†...
  }
}
```

---

## 4. å‰ç«¯UIè®¾è®¡

### 4.1 åå°ç®¡ç† - æ”¯ä»˜è®¾ç½®é¡µé¢

**è·¯å¾„**ï¼š`/backendmanager/settings/payment`

#### 4.1.1 é¡µé¢å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ”¯ä»˜è®¾ç½®                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚ ã€æ”¯ä»˜æ¨¡å¼ã€‘                                             â”‚
â”‚  â—‹ æ¨¡æ‹Ÿæ”¯ä»˜ï¼ˆå¼€å‘/æµ‹è¯•ï¼‰                                  â”‚
â”‚  â—‹ çœŸå®æ”¯ä»˜ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰                                   â”‚
â”‚                                                         â”‚
â”‚  âš ï¸ æç¤ºï¼šæ¨¡æ‹Ÿæ”¯ä»˜æ— éœ€é…ç½®å•†æˆ·ä¿¡æ¯ï¼Œé€‚ç”¨äºå¼€å‘æµ‹è¯•        â”‚
â”‚                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚ ã€æ”¯ä»˜å®æ”¯ä»˜ã€‘                                           â”‚
â”‚  [âœ“] å¯ç”¨æ”¯ä»˜å®æ”¯ä»˜                                      â”‚
â”‚                                                         â”‚
â”‚  åº”ç”¨ID (App ID): [________________]                    â”‚
â”‚  åº”ç”¨ç§é’¥ (Private Key): [________________] [æŸ¥çœ‹]       â”‚
â”‚  æ”¯ä»˜å®å…¬é’¥ (Public Key): [________________] [æŸ¥çœ‹]      â”‚
â”‚  ç½‘å…³åœ°å€: [https://openapi.alipay.com/gateway.do]      â”‚
â”‚                                                         â”‚
â”‚  [æµ‹è¯•è¿æ¥]                          çŠ¶æ€: â— æœªé…ç½®      â”‚
â”‚                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚ ã€å¾®ä¿¡æ”¯ä»˜ã€‘                                             â”‚
â”‚  [âœ“] å¯ç”¨å¾®ä¿¡æ”¯ä»˜                                        â”‚
â”‚                                                         â”‚
â”‚  åº”ç”¨ID (App ID): [________________]                    â”‚
â”‚  å•†æˆ·å· (Mch ID): [________________]                    â”‚
â”‚  APIå¯†é’¥ (API Key): [________________] [æŸ¥çœ‹]           â”‚
â”‚                                                         â”‚
â”‚  [æµ‹è¯•è¿æ¥]                          çŠ¶æ€: â— æœªé…ç½®      â”‚
â”‚                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚ ã€PayPalæ”¯ä»˜ã€‘                                          â”‚
â”‚  [ ] å¯ç”¨PayPalæ”¯ä»˜                                     â”‚
â”‚                                                         â”‚
â”‚  Client ID: [________________]                          â”‚
â”‚  Client Secret: [________________] [æŸ¥çœ‹]               â”‚
â”‚  ç¯å¢ƒ: â—‹ Sandbox  â—‹ Live                                â”‚
â”‚                                                         â”‚
â”‚  [æµ‹è¯•è¿æ¥]                          çŠ¶æ€: â— æœªé…ç½®      â”‚
â”‚                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  [ä¿å­˜é…ç½®]  [é‡ç½®]                                      â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.1.2 é…ç½®çŠ¶æ€æŒ‡ç¤º

- **â— æœªé…ç½®**ï¼ˆç°è‰²ï¼‰ï¼šæœªå¡«å†™å¿…è¦çš„å•†æˆ·ä¿¡æ¯
- **â— å·²é…ç½®**ï¼ˆæ©™è‰²ï¼‰ï¼šå·²å¡«å†™ä½†æœªæµ‹è¯•è¿æ¥
- **â— æ­£å¸¸**ï¼ˆç»¿è‰²ï¼‰ï¼šé…ç½®æ­£ç¡®ä¸”æµ‹è¯•é€šè¿‡
- **â— å¼‚å¸¸**ï¼ˆçº¢è‰²ï¼‰ï¼šé…ç½®é”™è¯¯æˆ–è¿æ¥å¤±è´¥

#### 4.1.3 å®‰å…¨æ€§è®¾è®¡

1. **å¯†é’¥å­—æ®µé»˜è®¤éšè—**ï¼šæ˜¾ç¤ºä¸º `********`ï¼Œç‚¹å‡»"æŸ¥çœ‹"æŒ‰é’®æ‰æ˜¾ç¤º
2. **å¯†é’¥è¾“å…¥æç¤º**ï¼šä½¿ç”¨å¯†ç è¾“å…¥æ¡†ï¼Œæ”¯æŒæ˜¾ç¤º/éšè—åˆ‡æ¢
3. **é…ç½®å˜æ›´ç¡®è®¤**ï¼šåˆ‡æ¢æ”¯ä»˜æ¨¡å¼æ—¶éœ€è¦äºŒæ¬¡ç¡®è®¤
4. **æƒé™æ ¡éªŒ**ï¼šä»… ADMIN è§’è‰²å¯è®¿é—®è¯¥é¡µé¢

### 4.2 ç”¨æˆ·ç«¯ - æ”¯ä»˜æ–¹å¼é€‰æ‹©

**è·¯å¾„**ï¼š`/payment/[orderId]`

#### 4.2.1 æ”¯ä»˜æ–¹å¼åˆ—è¡¨

- ä»…æ˜¾ç¤ºå·²å¯ç”¨çš„æ”¯ä»˜æ–¹å¼
- å¦‚æœæ”¯ä»˜æ¨¡å¼ä¸º"æ¨¡æ‹Ÿ"ï¼Œæ˜¾ç¤º"æ¼”ç¤ºæ¨¡å¼"æ ‡è¯†
- çœŸå®æ”¯ä»˜æ—¶ï¼Œä¸æ˜¾ç¤ºä»»ä½•ç‰¹æ®Šæ ‡è¯†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é€‰æ‹©æ”¯ä»˜æ–¹å¼                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  [ ] ğŸ’° æ”¯ä»˜å®æ”¯ä»˜                       â”‚
â”‚      å¿«æ·å®‰å…¨ï¼Œæ”¯æŒèŠ±å‘—åˆ†æœŸ               â”‚
â”‚                                         â”‚
â”‚  [ ] ğŸ’š å¾®ä¿¡æ”¯ä»˜                        â”‚
â”‚      å¾®ä¿¡æ‰«ç ï¼Œæ–¹ä¾¿å¿«æ·                   â”‚
â”‚                                         â”‚
â”‚  è®¢å•é‡‘é¢: Â¥99.00                       â”‚
â”‚                                         â”‚
â”‚  [ç¡®è®¤æ”¯ä»˜]                              â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. æ”¯ä»˜æµç¨‹è®¾è®¡

### 5.1 æ¨¡æ‹Ÿæ”¯ä»˜æµç¨‹

```
ç”¨æˆ·é€‰æ‹©å•†å“ â†’ åˆ›å»ºè®¢å• â†’ é€‰æ‹©æ”¯ä»˜æ–¹å¼
                              â†“
                    è·å–æ”¯ä»˜æ¨¡å¼é…ç½® (mock)
                              â†“
                    ç”Ÿæˆæ¨¡æ‹Ÿæ”¯ä»˜é¡µé¢é“¾æ¥
                              â†“
              è·³è½¬åˆ° /api/payment/mock?paymentId=xxx
                              â†“
                    æ˜¾ç¤ºæ¨¡æ‹Ÿæ”¯ä»˜é¡µé¢
                              â†“
           ç”¨æˆ·ç‚¹å‡»"ç¡®è®¤æ”¯ä»˜" â†’ è°ƒç”¨å›è°ƒAPI
                              â†“
                    æ›´æ–°è®¢å•çŠ¶æ€ä¸º "paid"
                              â†“
                    è·³è½¬åˆ°æ”¯ä»˜æˆåŠŸé¡µé¢
```

### 5.2 çœŸå®æ”¯ä»˜æµç¨‹ï¼ˆä»¥æ”¯ä»˜å®ä¸ºä¾‹ï¼‰

```
ç”¨æˆ·é€‰æ‹©å•†å“ â†’ åˆ›å»ºè®¢å• â†’ é€‰æ‹©æ”¯ä»˜æ–¹å¼
                              â†“
                    è·å–æ”¯ä»˜æ¨¡å¼é…ç½® (real)
                              â†“
                    æ£€æŸ¥æ”¯ä»˜å®é…ç½®æ˜¯å¦å®Œæ•´
                              â†“
                    è°ƒç”¨æ”¯ä»˜å®SDKç”Ÿæˆæ”¯ä»˜é“¾æ¥
                              â†“
              è·³è½¬åˆ°æ”¯ä»˜å®æ”¯ä»˜é¡µé¢ (alipay.com)
                              â†“
                    ç”¨æˆ·åœ¨æ”¯ä»˜å®å®Œæˆæ”¯ä»˜
                              â†“
             æ”¯ä»˜å®å¼‚æ­¥é€šçŸ¥ â†’ /api/payment/callback/alipay
                              â†“
                    éªŒè¯ç­¾åå¹¶æ›´æ–°è®¢å•çŠ¶æ€
                              â†“
             æ”¯ä»˜å®åŒæ­¥è·³è½¬ â†’ /payment/callback/alipay
                              â†“
                    è·³è½¬åˆ°æ”¯ä»˜æˆåŠŸé¡µé¢
```

---

## 6. ç¯å¢ƒå˜é‡é…ç½®

### 6.1 å¼€å‘ç¯å¢ƒ (.env.local)

```bash
# æ”¯ä»˜æ¨¡å¼ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä»æ•°æ®åº“è¯»å–ï¼‰
PAYMENT_MODE=mock

# æ”¯ä»˜å®é…ç½®ï¼ˆå¯é€‰ï¼Œä¼˜å…ˆä»æ•°æ®åº“è¯»å–ï¼‰
ALIPAY_APP_ID=
ALIPAY_PRIVATE_KEY=
ALIPAY_PUBLIC_KEY=

# å¾®ä¿¡æ”¯ä»˜é…ç½®ï¼ˆå¯é€‰ï¼‰
WECHAT_APP_ID=
WECHAT_MCH_ID=
WECHAT_API_KEY=

# PayPalé…ç½®ï¼ˆå¯é€‰ï¼‰
PAYPAL_CLIENT_ID=
PAYPAL_CLIENT_SECRET=
PAYPAL_MODE=sandbox
```

### 6.2 é…ç½®ä¼˜å…ˆçº§

1. **æ•°æ®åº“é…ç½®**ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰ï¼šä» SystemConfig è¡¨è¯»å–
2. **ç¯å¢ƒå˜é‡**ï¼ˆæ¬¡ä¼˜å…ˆçº§ï¼‰ï¼šä» .env æ–‡ä»¶è¯»å–
3. **é»˜è®¤å€¼**ï¼ˆæœ€ä½ä¼˜å…ˆçº§ï¼‰ï¼šä»£ç ä¸­å®šä¹‰çš„é»˜è®¤å€¼

**ä¼˜åŠ¿**ï¼š
- æ”¯æŒè¿è¡Œæ—¶åŠ¨æ€åˆ‡æ¢é…ç½®ï¼ˆæ— éœ€é‡å¯ï¼‰
- æ”¯æŒå¤šç¯å¢ƒéƒ¨ç½²ï¼ˆå¼€å‘/æµ‹è¯•/ç”Ÿäº§ï¼‰
- æ•æ„Ÿä¿¡æ¯å¯å­˜å‚¨åœ¨æ•°æ®åº“å¹¶åŠ å¯†

---

## 7. å®‰å…¨æ€§è®¾è®¡

### 7.1 æ•æ„Ÿä¿¡æ¯åŠ å¯†

å¯¹ä»¥ä¸‹å­—æ®µè¿›è¡ŒåŠ å¯†å­˜å‚¨ï¼š
- `alipay_private_key`
- `wechat_api_key`
- `paypal_client_secret`

**åŠ å¯†æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨ AES-256-GCM åŠ å¯†ç®—æ³•
- åŠ å¯†å¯†é’¥å­˜å‚¨åœ¨ç¯å¢ƒå˜é‡ `ENCRYPTION_KEY` ä¸­
- å­˜å‚¨æ ¼å¼ï¼š`encrypted:${iv}:${encryptedData}:${authTag}`

### 7.2 APIæƒé™æ§åˆ¶

| APIè·¯å¾„ | æƒé™è¦æ±‚ | è¯´æ˜ |
|---------|---------|------|
| `/api/backendmanager/system-config/payment` | ADMIN | ç®¡ç†å‘˜æŸ¥çœ‹/ç¼–è¾‘æ”¯ä»˜é…ç½® |
| `/api/system-config` | PUBLIC | ç”¨æˆ·æŸ¥çœ‹å…¬å¼€é…ç½®ï¼ˆä¸å«æ•æ„Ÿä¿¡æ¯ï¼‰ |
| `/api/payment/create` | USER/GUEST | åˆ›å»ºæ”¯ä»˜è®¢å• |
| `/api/payment/callback/*` | PUBLIC | æ”¯ä»˜å¹³å°å›è°ƒï¼ˆéœ€éªŒè¯ç­¾åï¼‰ |

### 7.3 é…ç½®éªŒè¯

åœ¨ä¿å­˜æ”¯ä»˜é…ç½®æ—¶è¿›è¡ŒéªŒè¯ï¼š

1. **æ ¼å¼éªŒè¯**ï¼š
   - App ID æ ¼å¼æ£€æŸ¥
   - å¯†é’¥é•¿åº¦æ£€æŸ¥
   - URL æ ¼å¼éªŒè¯

2. **è¿é€šæ€§æµ‹è¯•**ï¼ˆå¯é€‰ï¼‰ï¼š
   - è°ƒç”¨æ”¯ä»˜å¹³å°æµ‹è¯•æ¥å£
   - éªŒè¯å¯†é’¥æ˜¯å¦æœ‰æ•ˆ

3. **å®Œæ•´æ€§æ£€æŸ¥**ï¼š
   - å¿…å¡«å­—æ®µä¸èƒ½ä¸ºç©º
   - å…³è”å­—æ®µåŒæ—¶å­˜åœ¨ï¼ˆå¦‚ App ID å’Œå¯†é’¥ï¼‰

---

## 8. é”™è¯¯å¤„ç†

### 8.1 é…ç½®é”™è¯¯

| é”™è¯¯åœºæ™¯ | é”™è¯¯ç  | é”™è¯¯ä¿¡æ¯ | å¤„ç†æ–¹å¼ |
|---------|-------|---------|---------|
| æ”¯ä»˜é…ç½®æœªå®Œæˆ | `PAYMENT_CONFIG_INCOMPLETE` | "æ”¯ä»˜é…ç½®ä¸å®Œæ•´ï¼Œè¯·è”ç³»ç®¡ç†å‘˜" | å‰ç«¯æç¤ºï¼Œç¦ç”¨è¯¥æ”¯ä»˜æ–¹å¼ |
| æ”¯ä»˜æ–¹å¼æœªå¯ç”¨ | `PAYMENT_METHOD_DISABLED` | "è¯¥æ”¯ä»˜æ–¹å¼æš‚æœªå¼€æ”¾" | å‰ç«¯éšè—è¯¥æ”¯ä»˜é€‰é¡¹ |
| å¯†é’¥éªŒè¯å¤±è´¥ | `PAYMENT_CREDENTIALS_INVALID` | "æ”¯ä»˜å¯†é’¥éªŒè¯å¤±è´¥" | ç®¡ç†åå°æç¤ºé‡æ–°é…ç½® |

### 8.2 æ”¯ä»˜é”™è¯¯

| é”™è¯¯åœºæ™¯ | å¤„ç†æ–¹å¼ |
|---------|---------|
| åˆ›å»ºæ”¯ä»˜è®¢å•å¤±è´¥ | è®°å½•æ—¥å¿—ï¼Œå‘ç”¨æˆ·å±•ç¤ºå‹å¥½æç¤º |
| æ”¯ä»˜å›è°ƒç­¾åéªŒè¯å¤±è´¥ | æ‹’ç»è¯·æ±‚ï¼Œè®°å½•å®‰å…¨æ—¥å¿— |
| æ”¯ä»˜å¹³å°è¿æ¥è¶…æ—¶ | æç¤ºç”¨æˆ·ç¨åé‡è¯• |
| è®¢å•çŠ¶æ€å¼‚å¸¸ | é˜»æ­¢æ”¯ä»˜ï¼Œæç¤ºè”ç³»å®¢æœ |

---

## 9. ç›‘æ§å’Œæ—¥å¿—

### 9.1 æ”¯ä»˜æ—¥å¿—

åœ¨ Payment è¡¨çš„ `paymentData` å­—æ®µä¸­è®°å½•ï¼š

```json
{
  "mode": "real",
  "provider": "alipay",
  "request_time": "2024-01-15T10:30:00Z",
  "response_time": "2024-01-15T10:30:02Z",
  "transaction_id": "2024011522001xxxxx",
  "error": null,
  "callback_received": true,
  "callback_time": "2024-01-15T10:31:00Z"
}
```

### 9.2 ç³»ç»Ÿæ—¥å¿—

è®°å½•ä»¥ä¸‹äº‹ä»¶ï¼š

1. **é…ç½®å˜æ›´**ï¼š
   - æ”¯ä»˜æ¨¡å¼åˆ‡æ¢ï¼ˆmock â†” realï¼‰
   - æ”¯ä»˜æ–¹å¼å¯ç”¨/åœç”¨
   - å•†æˆ·ä¿¡æ¯æ›´æ–°

2. **æ”¯ä»˜äº‹ä»¶**ï¼š
   - æ”¯ä»˜åˆ›å»º
   - æ”¯ä»˜å›è°ƒæ¥æ”¶
   - ç­¾åéªŒè¯å¤±è´¥ï¼ˆå®‰å…¨äº‹ä»¶ï¼‰

3. **é”™è¯¯äº‹ä»¶**ï¼š
   - é…ç½®é”™è¯¯
   - APIè°ƒç”¨å¤±è´¥
   - å¼‚å¸¸è®¢å•çŠ¶æ€

---

## 10. è¿ç§»å’Œéƒ¨ç½²

### 10.1 æ•°æ®åº“è¿ç§»

**æ­¥éª¤**ï¼š

1. æ·»åŠ æ–°çš„ SystemConfig è®°å½•ï¼š

```sql
-- æ”¯ä»˜æ¨¡å¼é…ç½®
INSERT INTO SystemConfig (id, key, value, type, category, description)
VALUES
  (cuid(), 'payment_mode', 'mock', 'string', 'payment', 'æ”¯ä»˜æ¨¡å¼ï¼šmock=æ¨¡æ‹Ÿæ”¯ä»˜ï¼Œreal=çœŸå®æ”¯ä»˜'),
  (cuid(), 'alipay_app_id', '', 'string', 'payment', 'æ”¯ä»˜å®åº”ç”¨APPID'),
  (cuid(), 'alipay_private_key', '', 'string', 'payment', 'æ”¯ä»˜å®åº”ç”¨ç§é’¥'),
  (cuid(), 'alipay_public_key', '', 'string', 'payment', 'æ”¯ä»˜å®å…¬é’¥'),
  -- ... å…¶ä»–é…ç½®
```

2. è¿è¡Œè¿ç§»è„šæœ¬ï¼š

```bash
npx prisma migrate dev --name add_payment_config
```

### 10.2 ç¯å¢ƒéƒ¨ç½²å»ºè®®

| ç¯å¢ƒ | æ”¯ä»˜æ¨¡å¼ | å»ºè®®é…ç½® |
|------|---------|---------|
| æœ¬åœ°å¼€å‘ | mock | æ— éœ€é…ç½®å•†æˆ·ä¿¡æ¯ |
| æµ‹è¯•ç¯å¢ƒ | mock æˆ– sandbox | ä½¿ç”¨æ”¯ä»˜å¹³å°æ²™ç®±ç¯å¢ƒ |
| é¢„å‘å¸ƒç¯å¢ƒ | sandbox | ä½¿ç”¨æ”¯ä»˜å¹³å°æ²™ç®±ç¯å¢ƒ |
| ç”Ÿäº§ç¯å¢ƒ | real | ä½¿ç”¨çœŸå®å•†æˆ·ä¿¡æ¯ |

---

## 11. æµ‹è¯•è®¡åˆ’

### 11.1 åŠŸèƒ½æµ‹è¯•

- [ ] æ”¯ä»˜æ¨¡å¼åˆ‡æ¢ï¼ˆmock â†” realï¼‰
- [ ] æ”¯ä»˜æ–¹å¼å¯ç”¨/åœç”¨
- [ ] æ”¯ä»˜é…ç½®ä¿å­˜å’Œè¯»å–
- [ ] å¯†é’¥å­—æ®µåŠ å¯†å­˜å‚¨
- [ ] é…ç½®æµ‹è¯•åŠŸèƒ½

### 11.2 é›†æˆæµ‹è¯•

- [ ] æ¨¡æ‹Ÿæ”¯ä»˜å®Œæ•´æµç¨‹
- [ ] æ”¯ä»˜å®æ²™ç®±æ”¯ä»˜æµç¨‹
- [ ] å¾®ä¿¡æ²™ç®±æ”¯ä»˜æµç¨‹
- [ ] PayPalæ²™ç®±æ”¯ä»˜æµç¨‹
- [ ] æ”¯ä»˜å›è°ƒå¤„ç†

### 11.3 å®‰å…¨æµ‹è¯•

- [ ] éç®¡ç†å‘˜è®¿é—®æ”¯ä»˜é…ç½®APIï¼ˆåº”æ‹’ç»ï¼‰
- [ ] å¯†é’¥å­—æ®µå‰ç«¯éšè—
- [ ] æ”¯ä»˜å›è°ƒç­¾åéªŒè¯
- [ ] SQLæ³¨å…¥é˜²æŠ¤
- [ ] XSSæ”»å‡»é˜²æŠ¤

---

## 12. æ–‡æ¡£å’ŒåŸ¹è®­

### 12.1 ç®¡ç†å‘˜æ–‡æ¡£

åˆ›å»º `docs/admin/payment-setup.md`ï¼ŒåŒ…å«ï¼š

1. å¦‚ä½•æ³¨å†Œæ”¯ä»˜å®/å¾®ä¿¡/PayPalå•†æˆ·
2. å¦‚ä½•è·å–å•†æˆ·ä¿¡æ¯ï¼ˆApp IDã€å¯†é’¥ç­‰ï¼‰
3. å¦‚ä½•åœ¨åå°é…ç½®æ”¯ä»˜æ¥å£
4. å¦‚ä½•æµ‹è¯•æ”¯ä»˜åŠŸèƒ½
5. å¸¸è§é—®é¢˜è§£ç­”

### 12.2 å¼€å‘è€…æ–‡æ¡£

åˆ›å»º `docs/dev/payment-integration.md`ï¼ŒåŒ…å«ï¼š

1. æ”¯ä»˜ç³»ç»Ÿæ¶æ„è¯´æ˜
2. APIæ¥å£æ–‡æ¡£
3. æ•°æ®åº“è¡¨ç»“æ„
4. ç¯å¢ƒå˜é‡é…ç½®è¯´æ˜
5. æœ¬åœ°å¼€å‘æŒ‡å—

---

## 13. æœªæ¥æ‰©å±•

### 13.1 æ”¯æŒæ›´å¤šæ”¯ä»˜æ–¹å¼

- é“¶è”æ”¯ä»˜
- æ•°å­—è´§å¸æ”¯ä»˜ï¼ˆUSDTï¼‰
- Stripe

### 13.2 é«˜çº§åŠŸèƒ½

- æ”¯ä»˜æ•°æ®ç»Ÿè®¡åˆ†æ
- è‡ªåŠ¨é€€æ¬¾åŠŸèƒ½
- æ”¯ä»˜åˆ†è´¦ï¼ˆå¤šå•†æˆ·ï¼‰
- è®¢é˜…åˆ¶æ”¯ä»˜

### 13.3 å›½é™…åŒ–

- å¤šå¸ç§æ”¯æŒ
- æ±‡ç‡è‡ªåŠ¨è½¬æ¢
- å›½é™…æ”¯ä»˜æ–¹å¼ï¼ˆStripeã€Apple Payã€Google Payï¼‰

---

## 14. æ€»ç»“

æœ¬è®¾è®¡æ–¹æ¡ˆå®ç°äº†çµæ´»çš„æ”¯ä»˜é…ç½®ç³»ç»Ÿï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

âœ… **æ˜“ç”¨æ€§**ï¼šç®¡ç†å‘˜å¯é€šè¿‡ç•Œé¢é…ç½®ï¼Œæ— éœ€ä¿®æ”¹ä»£ç 
âœ… **çµæ´»æ€§**ï¼šæ”¯æŒæ¨¡æ‹Ÿ/çœŸå®æ”¯ä»˜åŠ¨æ€åˆ‡æ¢
âœ… **å®‰å…¨æ€§**ï¼šæ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨ï¼Œæƒé™ä¸¥æ ¼æ§åˆ¶
âœ… **å¯æ‰©å±•æ€§**ï¼šæ˜“äºæ·»åŠ æ–°çš„æ”¯ä»˜æ–¹å¼
âœ… **å¯ç»´æŠ¤æ€§**ï¼šé…ç½®é›†ä¸­ç®¡ç†ï¼Œæ—¥å¿—å®Œæ•´è®°å½•

è¯¥ç³»ç»Ÿèƒ½å¤Ÿæ»¡è¶³ä»å¼€å‘æµ‹è¯•åˆ°ç”Ÿäº§éƒ¨ç½²çš„å„ä¸ªé˜¶æ®µéœ€æ±‚ï¼Œä¸ºè™šæ‹Ÿå•†å“å”®å–å¹³å°æä¾›ç¨³å®šå¯é çš„æ”¯ä»˜èƒ½åŠ›ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**åˆ›å»ºæ—¥æœŸ**ï¼š2024-01-15
**æœ€åæ›´æ–°**ï¼š2024-01-15
**ä½œè€…**ï¼šClaude
**å®¡æ ¸çŠ¶æ€**ï¼šå¾…å®¡æ ¸
