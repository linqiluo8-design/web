// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 用户模型
model User {
  id            String        @id @default(cuid())
  name          String?
  email         String        @unique
  emailVerified DateTime?
  password      String?
  image         String?
  role          UserRole      @default(USER)
  accountStatus AccountStatus @default(PENDING) // 账号审核状态
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  accounts      Account[]
  sessions      Session[]
  cartItems     CartItem[]
  orders        Order[]
  permissions   Permission[]  // 用户权限
  memberships   Membership[]  // 用户购买的会员
  distributor   Distributor?  // 分销商信息
}

enum UserRole {
  USER
  ADMIN
}

enum AccountStatus {
  PENDING   // 待审核
  APPROVED  // 已批准
  REJECTED  // 已拒绝
}

// 用户权限模型
model Permission {
  id        String          @id @default(cuid())
  userId    String
  module    PermissionModule  // 权限模块
  level     PermissionLevel   // 权限级别
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, module])
}

enum PermissionModule {
  CATEGORIES       // 分类管理
  MEMBERSHIPS      // 会员管理
  ORDERS           // 订单数据管理
  PRODUCTS         // 商品管理
  BANNERS          // 轮播图管理
  SYSTEM_SETTINGS  // 系统设置
  SECURITY_ALERTS  // 安全警报
  CUSTOMER_CHAT    // 客服聊天
  USER_MANAGEMENT  // 用户管理
  ORDER_LOOKUP     // 订单查询
  ANALYTICS        // 浏览量统计
  SYSTEM_LOGS      // 系统日志管理
  DISTRIBUTION     // 分销管理
}

enum PermissionLevel {
  NONE   // 无权限
  READ   // 只读
  WRITE  // 读写
}

// NextAuth账户模型
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

// NextAuth会话模型
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// 验证令牌模型
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// 分类模型
model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  coverImage  String?
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  products    Product[]
}

// 商品模型（知识付费产品）
model Product {
  id          String   @id @default(cuid())
  title       String
  description String
  content     String?  // 商品详细内容
  price       Float
  coverImage  String?
  showImage   Boolean  @default(true) // 是否显示图片
  categoryId  String?
  category    String?  // 保留兼容旧数据
  tags        String?  // JSON字符串存储标签
  status      String   @default("active") // active, inactive, archived
  networkDiskLink String? // 网盘链接（课程资源）
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  categoryRef Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  cartItems   CartItem[]
  orderItems  OrderItem[]
}

// 购物车项模型
model CartItem {
  id        String   @id @default(cuid())
  userId    String
  productId String
  quantity  Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
}

// 订单模型
model Order {
  id             String   @id @default(cuid())
  userId         String?  // 可选，支持匿名订单
  membershipId   String?  // 可选，使用会员码购买
  distributorId  String?  // 可选，分销商ID（通过分销链接下单）
  orderNumber    String   @unique
  totalAmount    Float
  originalAmount Float?  // 原价（使用会员折扣前）
  discount       Float?   // 使用的折扣率
  status         String   @default("pending") // pending, paid, cancelled, refunded
  paymentMethod  String?  // alipay, wechat, paypal
  expiresAt      DateTime? // 订单过期时间（15分钟后自动取消）
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user             User?              @relation(fields: [userId], references: [id], onDelete: Cascade)
  membership       Membership?        @relation(fields: [membershipId], references: [id], onDelete: SetNull)
  distributor      Distributor?       @relation(fields: [distributorId], references: [id], onDelete: SetNull)
  orderItems       OrderItem[]
  payment          Payment?
  distributionOrder DistributionOrder?
}

// 订单项模型
model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  productId String
  quantity  Int
  price     Float    // 购买时的价格
  createdAt DateTime @default(now())

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])
}

// 支付记录模型
model Payment {
  id              String   @id @default(cuid())
  orderId         String   @unique
  paymentMethod   String   // alipay, wechat, paypal
  transactionId   String?  // 第三方支付平台的交易ID
  amount          Float
  currency        String   @default("CNY")
  status          String   @default("pending") // pending, completed, failed, refunded
  paymentData     String?  // JSON字符串存储支付详情
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

// 会员方案模型
model MembershipPlan {
  id          String   @id @default(cuid())
  name        String   // 会员名称，如"年度会员"
  price       Float    // 价格
  duration    Int      // 有效期（天数），-1表示终身
  discount    Float    // 折扣率，如0.8表示8折
  dailyLimit  Int      // 每日折扣次数限制
  status      String   @default("active") // active, inactive
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  memberships Membership[]
}

// 会员购买记录模型
model Membership {
  id              String   @id @default(cuid())
  userId          String?  // 购买用户ID（可选，支持匿名购买）
  membershipCode  String   @unique // 唯一会员码（哈希）
  planId          String
  planSnapshot    String   // JSON字符串，保存购买时的方案配置
  purchasePrice   Float    // 购买时的价格
  discount        Float    // 购买时的折扣率
  dailyLimit      Int      // 购买时的每日限制
  duration        Int      // 购买时的有效期（天数）
  startDate       DateTime @default(now())
  endDate         DateTime? // 过期时间，null表示终身
  status          String   @default("active") // active, expired, cancelled
  orderNumber     String?  // 关联订单号
  paymentMethod   String?  // 支付方式：alipay, wechat, paypal
  paymentStatus   String   @default("pending") // pending, completed, failed
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  plan            MembershipPlan @relation(fields: [planId], references: [id])
  usageRecords    MembershipUsage[]
  orders          Order[]
}

// 会员使用记录模型（每日统计）
model MembershipUsage {
  id            String   @id @default(cuid())
  membershipId  String
  usageDate     DateTime // 使用日期（只记录日期部分）
  count         Int      @default(0) // 当天使用次数
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  membership    Membership @relation(fields: [membershipId], references: [id], onDelete: Cascade)

  @@unique([membershipId, usageDate])
}

// 页面访问记录模型（用于统计分析）
model PageView {
  id          String   @id @default(cuid())
  visitorId   String   // 访客唯一标识（session fingerprint）
  userId      String?  // 如果是登录用户，记录用户ID
  ipAddress   String   // 访问者IP地址
  userAgent   String?  // User Agent字符串
  path        String   // 访问路径
  referer     String?  // 来源页面URL
  country     String?  // 国家/地区
  city        String?  // 城市
  timestamp   DateTime @default(now())

  @@index([timestamp]) // 按时间索引，方便按时间范围查询
  @@index([visitorId]) // 按访客ID索引，用于统计UV
  @@index([path])      // 按路径索引，用于统计各页面访问量
  @@index([userId])    // 按用户ID索引
}

// 轮播图模型（首页广告/活动展示）
model Banner {
  id          String   @id @default(cuid())
  title       String   // 轮播图标题
  image       String   // 图片URL
  link        String?  // 点击跳转链接（可选）
  description String?  // 描述
  sortOrder   Int      @default(0) // 排序顺序，数字越小越靠前
  status      String   @default("active") // active, inactive
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// 系统配置模型（全局设置）
model SystemConfig {
  id        String   @id @default(cuid())
  key       String   @unique // 配置键，如 "banner_enabled", "payment_alipay_enabled"
  value     String   // 配置值（JSON字符串或简单值）
  type      String   // 配置类型：boolean, string, number, json
  category  String   // 配置分类：banner, payment, general
  description String? // 配置描述
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 安全警报模型（记录异常行为）
model SecurityAlert {
  id          String   @id @default(cuid())
  type        String   // 警报类型：ZERO_AMOUNT_ORDER, PRICE_MANIPULATION, etc.
  severity    String   @default("medium") // low, medium, high, critical
  userId      String?  // 相关用户ID（如果有）
  ipAddress   String?  // IP地址
  userAgent   String?  // User Agent
  description String   // 警报描述
  metadata    String?  // JSON字符串，存储相关数据
  status      String   @default("unresolved") // unresolved, investigating, resolved, false_positive
  resolvedBy  String?  // 处理人员ID
  resolvedAt  DateTime? // 处理时间
  notes       String?  // 处理备注
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type])
  @@index([severity])
  @@index([status])
  @@index([createdAt])
}

// 客服聊天会话模型
model ChatSession {
  id            String   @id @default(cuid())
  visitorId     String   // 访客唯一标识（未登录用户）或用户ID
  userId        String?  // 如果是登录用户，关联用户ID
  visitorName   String?  // 访客姓名（可选）
  visitorEmail  String?  // 访客邮箱（可选）
  status        String   @default("active") // active, closed
  lastMessageAt DateTime @default(now()) // 最后一条消息时间
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  messages      ChatMessage[]

  @@index([visitorId])
  @@index([userId])
  @@index([status])
  @@index([lastMessageAt])
}

// 聊天消息模型
model ChatMessage {
  id          String   @id @default(cuid())
  sessionId   String   // 关联聊天会话
  senderType  String   // visitor, admin
  senderId    String?  // 发送者ID（管理员ID或访客ID）
  senderName  String?  // 发送者姓名
  message     String   // 消息内容（文本消息或图片说明）
  messageType String   @default("text") // 消息类型：text, image
  imageUrl    String?  // 图片URL（当messageType为image时）
  imageWidth  Int?     // 图片宽度（像素）
  imageHeight Int?     // 图片高度（像素）
  isRead      Boolean  @default(false) // 是否已读
  createdAt   DateTime @default(now())

  session     ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([createdAt])
}

// 系统日志模型（记录系统运行日志）
model SystemLog {
  id          String   @id @default(cuid())
  level       String   // info, warn, error, debug
  category    String   // api, auth, payment, system, security, database
  action      String   // 操作名称，如 "order_created", "user_login", "payment_failed"
  message     String   // 日志消息
  userId      String?  // 相关用户ID（如果有）
  ipAddress   String?  // IP地址
  userAgent   String?  // User Agent
  path        String?  // API路径或页面路径
  method      String?  // HTTP方法：GET, POST, PUT, DELETE
  statusCode  Int?     // HTTP状态码
  duration    Int?     // 请求处理时长（毫秒）
  metadata    String?  // JSON字符串，存储额外数据
  error       String?  // 错误堆栈信息（仅error级别）
  createdAt   DateTime @default(now())

  @@index([level])
  @@index([category])
  @@index([action])
  @@index([createdAt])
  @@index([userId])
}

// 订单导出记录模型（用于限制匿名用户导出次数）
// 每个订单独立拥有导出次数配额
model OrderExportRecord {
  id          String   @id @default(cuid())
  userId      String?  // 用户ID（已登录用户）
  visitorId   String?  // 访客ID（匿名用户标识）
  orderNumber String   // 订单号（每个订单分别统计导出次数）
  exportDate  DateTime // 导出日期（只记录日期部分，用于按天统计）
  count       Int      @default(1) // 该订单当天导出次数
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, orderNumber, exportDate])
  @@unique([visitorId, orderNumber, exportDate])
  @@index([userId])
  @@index([visitorId])
  @@index([orderNumber])
  @@index([exportDate])
}

// 会员订单导出记录（用于限制匿名用户导出次数）
// 每个会员订单独立拥有导出次数配额
model MembershipExportRecord {
  id             String   @id @default(cuid())
  userId         String?  // 用户ID（已登录用户）
  visitorId      String?  // 访客ID（匿名用户标识）
  membershipCode String   // 会员码（每个会员订单分别统计导出次数）
  exportDate     DateTime // 导出日期（只记录日期部分，用于按天统计）
  count          Int      @default(1) // 该会员订单当天导出次数
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([userId, membershipCode, exportDate])
  @@unique([visitorId, membershipCode, exportDate])
  @@index([userId])
  @@index([visitorId])
  @@index([membershipCode])
  @@index([exportDate])
}

// ==================== 分销系统模型 ====================

// 分销商模型
model Distributor {
  id              String   @id @default(cuid())
  userId          String   @unique // 关联用户
  code            String   @unique // 分销商唯一码（用于生成分销链接）
  commissionRate  Float    @default(0.1) // 默认佣金比例（10%）
  status          String   @default("pending") // pending, active, suspended, rejected
  appliedAt       DateTime @default(now()) // 申请时间
  approvedAt      DateTime? // 审核通过时间
  approvedBy      String?  // 审核人员ID
  rejectedReason  String?  // 拒绝原因
  // 联系信息
  contactName     String?  // 联系人姓名
  contactPhone    String?  // 联系电话
  contactEmail    String?  // 联系邮箱
  // 银行信息（用于提现）
  bankName        String?  // 银行名称
  bankAccount     String?  // 银行账号
  bankAccountName String?  // 账户名
  // 统计数据
  totalEarnings   Float    @default(0) // 总收益
  availableBalance Float   @default(0) // 可提现余额
  withdrawnAmount Float    @default(0) // 已提现金额
  totalOrders     Int      @default(0) // 总订单数
  totalClicks     Int      @default(0) // 总点击数
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user              User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders            Order[]               // 通过分销链接产生的订单
  distributionOrders DistributionOrder[]  // 分销订单记录
  clicks            DistributionClick[]   // 点击记录
  withdrawals       CommissionWithdrawal[] // 提现记录

  @@index([code])
  @@index([status])
  @@index([userId])
}

// 分销订单记录（佣金计算和结算）
model DistributionOrder {
  id                String   @id @default(cuid())
  orderId           String   @unique // 关联订单
  distributorId     String   // 分销商ID
  orderAmount       Float    // 订单金额
  commissionAmount  Float    // 佣金金额
  commissionRate    Float    // 佣金比例（记录当时的比例）
  status            String   @default("pending") // pending, confirmed, settled, cancelled
  confirmedAt       DateTime? // 确认时间（订单支付成功后）
  settledAt         DateTime? // 结算时间（佣金发放到余额）
  cancelledAt       DateTime? // 取消时间（订单取消或退款）
  cancelReason      String?  // 取消原因
  notes             String?  // 备注
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  order       Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  distributor Distributor @relation(fields: [distributorId], references: [id], onDelete: Cascade)

  @@index([distributorId])
  @@index([status])
  @@index([createdAt])
}

// 分销链接点击记录
model DistributionClick {
  id            String   @id @default(cuid())
  distributorId String   // 分销商ID
  productId     String?  // 产品ID（可选）
  visitorId     String   // 访客唯一标识
  ipAddress     String   // 访问者IP
  userAgent     String?  // User Agent
  referer       String?  // 来源URL
  converted     Boolean  @default(false) // 是否转化为订单
  orderId       String?  // 转化的订单ID（如果有）
  clickedAt     DateTime @default(now())

  distributor Distributor @relation(fields: [distributorId], references: [id], onDelete: Cascade)

  @@index([distributorId])
  @@index([visitorId])
  @@index([productId])
  @@index([clickedAt])
}

// 佣金提现记录
model CommissionWithdrawal {
  id            String   @id @default(cuid())
  distributorId String   // 分销商ID
  amount        Float    // 提现金额
  fee           Float    @default(0) // 提现手续费
  actualAmount  Float    // 实际到账金额
  status        String   @default("pending") // pending, processing, completed, rejected
  // 银行信息（提现时的银行信息，可能与账户中的不同）
  bankName      String   // 银行名称
  bankAccount   String   // 银行账号
  bankAccountName String // 账户名
  // 处理信息
  processedBy   String?  // 处理人员ID
  processedAt   DateTime? // 处理时间
  completedAt   DateTime? // 完成时间
  rejectedReason String?  // 拒绝原因
  transactionId String?  // 交易ID/凭证号
  notes         String?  // 备注
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  distributor Distributor @relation(fields: [distributorId], references: [id], onDelete: Cascade)

  @@index([distributorId])
  @@index([status])
  @@index([createdAt])
}
