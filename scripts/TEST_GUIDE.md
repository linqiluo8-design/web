# 全站功能测试指南

## 概述

本测试脚本提供了一个全面的自动化测试方案，用于验证系统的所有核心功能。支持**模拟支付**和**真实支付**两种测试场景。

## 快速开始

### 1. 准备工作

确保您的开发环境已经启动：

```bash
# 启动开发服务器
npm run dev
```

### 2. 运行测试

#### 模拟支付测试（推荐）

```bash
node scripts/test-all-features.js mock
```

#### 真实支付测试（谨慎使用）

```bash
node scripts/test-all-features.js real
```

⚠️ **警告**：真实支付测试将产生实际的支付交易，仅在必要时使用！

### 3. 自定义测试环境

```bash
# 指定测试服务器地址
TEST_BASE_URL=https://your-staging-server.com node scripts/test-all-features.js mock
```

## 测试覆盖范围

### 1. 基础健康检查 ✓
- 首页可访问性
- API 端点响应
- 服务器状态

### 2. 用户认证 ✓
- 用户注册
- 用户登录
- 会话管理
- Cookie 和认证令牌

### 3. 商品功能 ✓
- 商品列表查询
- 商品详情获取
- 商品搜索
- 分页功能

### 4. 分类管理 ✓
- 分类列表
- 分类层级关系
- 分类商品关联

### 5. 会员方案 ✓
- 会员方案列表
- 方案详情
- 价格和权益信息

### 6. 订单流程 ✓
- 订单创建
- 订单详情查询
- 订单状态管理
- 购物车功能

### 7. 支付流程 ✓
- **模拟支付**：自动完成支付回调
- **真实支付**：支付宝/微信/PayPal 集成
- 支付状态更新
- 订单状态同步

### 8. 系统设置 ✓
- 系统配置读取
- 支付模式切换
- 功能开关

### 9. 轮播图 ✓
- 轮播图列表
- 图片加载
- 排序和状态

### 10. 浏览量统计 ✓
- 访问记录
- 统计数据（需要权限）

### 11. 页面可访问性 ✓
- 所有前端页面
- 路由正确性
- 权限控制

### 12. API 安全性 ✓
- 未授权访问保护
- 权限验证
- CSRF 防护

### 13. 数据库连接 ✓
- 数据库可用性
- 查询性能
- 连接池状态

### 14. 性能基准 ✓
- API 响应时间
- 页面加载速度
- 性能瓶颈识别

## 测试结果解读

### 通过率标准

| 通过率 | 状态 | 建议 |
|--------|------|------|
| ≥ 95% | ✅ 优秀 | 可以投入生产 |
| 80-94% | ⚠️ 良好 | 修复失败项后可投入生产 |
| < 80% | ❌ 不佳 | 需要进一步调试和修复 |

### 测试报告示例

```
==============================================================
  📊 测试报告
==============================================================

  总测试数: 45
  ✓ 通过: 43
  ✗ 失败: 2
  ⊘ 跳过: 3
  通过率: 95.56%
  总耗时: 12.34s

  失败的测试:
    1. 订单创建失败: 商品库存不足
    2. 支付回调超时

==============================================================
  ✅ 所有测试通过！系统可以投入生产使用。
==============================================================
```

## 常见问题

### Q1: 测试脚本报错 "ECONNREFUSED"

**原因**：开发服务器未启动

**解决**：
```bash
npm run dev
```

### Q2: 用户认证测试失败

**原因**：测试用户已存在但密码不匹配，或数据库连接问题

**解决**：
1. 检查数据库连接
2. 清理测试用户：删除 `test@example.com` 用户
3. 确认密码策略

### Q3: 订单创建失败

**原因**：商品列表为空

**解决**：
1. 确保数据库中有商品数据
2. 运行种子数据脚本
3. 手动创建测试商品

### Q4: 支付测试失败

**原因**：
- 模拟支付：支付回调 API 未实现
- 真实支付：支付配置不正确

**解决**：
1. 检查支付 API 端点
2. 验证支付密钥配置
3. 确认支付模式设置

### Q5: 性能测试显示响应慢

**原因**：服务器负载高或数据库查询未优化

**解决**：
1. 检查数据库索引
2. 优化 API 查询
3. 启用缓存
4. 考虑 CDN 加速

## 生产环境检查清单

在投入生产前，请确认以下事项：

### 功能完整性
- [ ] 所有核心功能测试通过
- [ ] 支付流程完整且安全
- [ ] 用户认证和授权正常
- [ ] 数据持久化正确

### 安全性
- [ ] API 有适当的权限保护
- [ ] 敏感数据已加密
- [ ] HTTPS 已启用
- [ ] CSRF/XSS 防护已实现
- [ ] SQL 注入防护
- [ ] 速率限制已配置

### 性能
- [ ] 主要 API 响应时间 < 1s
- [ ] 页面加载时间 < 3s
- [ ] 数据库查询已优化
- [ ] 静态资源已压缩

### 可靠性
- [ ] 错误处理完善
- [ ] 日志记录完整
- [ ] 备份策略已实施
- [ ] 监控告警已配置

### 配置
- [ ] 环境变量已正确设置
- [ ] 支付密钥已配置（生产环境）
- [ ] 邮件服务已配置
- [ ] 数据库连接池已优化

### 文档
- [ ] API 文档完整
- [ ] 部署文档已准备
- [ ] 运维手册已编写
- [ ] 用户手册已提供

## 持续集成（CI）

### GitHub Actions 示例

```yaml
name: Full Test Suite

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: npm install
      - run: npm run build
      - run: npm run dev &
      - run: sleep 10
      - run: node scripts/test-all-features.js mock
```

## 进阶使用

### 自定义测试配置

编辑 `scripts/test-all-features.js` 中的配置：

```javascript
const config = {
  baseUrl: process.env.TEST_BASE_URL || 'http://localhost:3000',
  paymentMode: process.argv[2] || 'mock',
  testUser: {
    email: 'test@example.com',
    password: 'Test123456',
    name: '测试用户'
  },
  timeout: 30000 // 30秒超时
};
```

### 添加自定义测试

```javascript
async function testCustomFeature() {
  logSection('X. 自定义功能测试');

  try {
    const { response, data } = await request('/api/custom');
    assert(response.ok, '自定义功能 API 正常');
    // 添加更多断言...
  } catch (error) {
    assert(false, `自定义功能测试失败: ${error.message}`);
  }
}

// 在 runAllTests() 中调用
await testCustomFeature();
```

## 支持和反馈

如果您在使用测试脚本时遇到问题或有改进建议，请：

1. 查看本文档的常见问题部分
2. 检查测试日志输出
3. 提交 Issue 或联系开发团队

## 更新日志

### v1.0.0 (2024-01-XX)
- 初始版本
- 支持 14 个测试模块
- 模拟支付和真实支付双模式
- 详细的测试报告
- 性能基准测试

---

**祝您测试顺利！🎉**
